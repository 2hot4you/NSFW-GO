<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš™ï¸ ç³»ç»Ÿé…ç½® - NSFW-Go</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="static/css/design-system.css">
    <link rel="stylesheet" href="static/css/components.css">
    <link rel="stylesheet" href="static/css/tailwind-fixes.css">
    <style>
        /* é¡µé¢ç‰¹å®šæ ·å¼ */
        .config-container {
            min-height: calc(100vh - 64px);
            padding: 2rem 1rem;
        }
        
        /* é…ç½®æ ‡ç­¾é¡µ */
        .config-tabs {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }
        
        .config-tabs::-webkit-scrollbar {
            height: 4px;
        }
        
        .config-tabs::-webkit-scrollbar-track {
            background: var(--bg-dark-tertiary);
        }
        
        .config-tabs::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }
        
        .config-tab {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            background: var(--bg-dark-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .config-tab:hover {
            background: var(--bg-dark-tertiary);
            transform: translateY(-2px);
        }
        
        .config-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* é…ç½®åŒºå— */
        .config-section {
            display: none;
        }
        
        .config-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        /* é…ç½®ç»„ */
        .config-group {
            background: var(--bg-dark-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .config-group-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        /* æµ‹è¯•ç»“æœ */
        .test-result {
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            display: none;
        }
        
        .test-result.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        .test-result.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }
        
        .test-result.show {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        /* æ•°ç»„è¾“å…¥ */
        .array-input {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .array-item {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .array-item input {
            flex: 1;
        }
        
        .array-item button {
            padding: 0.5rem;
            background: var(--danger);
            color: white;
            border-radius: 0.375rem;
            transition: all 0.2s;
        }
        
        .array-item button:hover {
            transform: scale(1.05);
            background: var(--danger-dark);
        }
        
        /* å¤‡ä»½é¡¹ */
        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-dark-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }
        
        .backup-item:hover {
            transform: translateX(4px);
            border-color: var(--primary);
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ å°†ç”±modern-nav.jsè‡ªåŠ¨æ’å…¥ -->
    
    <!-- ä¸»å†…å®¹åŒº -->
    <main class="config-container max-w-7xl mx-auto">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4">
                <span class="glow-text">âš™ï¸ ç³»ç»Ÿé…ç½®</span>
            </h1>
            <p class="text-lg text-muted">ç®¡ç†ç³»ç»Ÿé…ç½®ï¼Œä¼˜åŒ–è¿è¡Œå‚æ•° ğŸ”§</p>
        </div>
        
        <!-- æ“ä½œæ  -->
        <div class="glass-card p-6 mb-6">
            <div class="flex flex-wrap gap-3 justify-between items-center">
                <div class="flex gap-3">
                    <button onclick="loadConfig()" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i>
                        <span>é‡æ–°åŠ è½½</span>
                    </button>
                    <button onclick="validateConfig()" class="btn btn-warning">
                        <i class="fas fa-check-circle"></i>
                        <span>éªŒè¯é…ç½®</span>
                    </button>
                    <button onclick="saveConfig()" class="btn btn-success">
                        <i class="fas fa-save"></i>
                        <span>ä¿å­˜é…ç½®</span>
                    </button>
                </div>
                <div class="flex gap-3">
                    <button onclick="exportConfig()" class="btn btn-secondary">
                        <i class="fas fa-download"></i>
                        <span>å¯¼å‡ºé…ç½®</span>
                    </button>
                    <button onclick="importConfig()" class="btn btn-secondary">
                        <i class="fas fa-upload"></i>
                        <span>å¯¼å…¥é…ç½®</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- é…ç½®æ ‡ç­¾é¡µ -->
        <div class="glass-card p-4 mb-6">
            <div class="config-tabs">
                <button onclick="switchTab('server')" class="config-tab active">
                    <i class="fas fa-server"></i>
                    <span>æœåŠ¡å™¨</span>
                </button>
                <button onclick="switchTab('database')" class="config-tab">
                    <i class="fas fa-database"></i>
                    <span>æ•°æ®åº“</span>
                </button>
                <button onclick="switchTab('redis')" class="config-tab">
                    <i class="fas fa-memory"></i>
                    <span>Redis</span>
                </button>
                <button onclick="switchTab('telegram')" class="config-tab">
                    <i class="fab fa-telegram"></i>
                    <span>Telegram</span>
                </button>
                <button onclick="switchTab('crawler')" class="config-tab">
                    <i class="fas fa-spider"></i>
                    <span>çˆ¬è™«</span>
                </button>
                <button onclick="switchTab('media')" class="config-tab">
                    <i class="fas fa-folder"></i>
                    <span>åª’ä½“åº“</span>
                </button>
                <button onclick="switchTab('subscription')" class="config-tab">
                    <i class="fas fa-calendar-check"></i>
                    <span>è®¢é˜…ä¸‹è½½</span>
                </button>
                <button onclick="switchTab('torrent')" class="config-tab">
                    <i class="fas fa-download"></i>
                    <span>ç§å­ä¸‹è½½</span>
                </button>
                <button onclick="switchTab('security')" class="config-tab">
                    <i class="fas fa-shield-alt"></i>
                    <span>å®‰å…¨</span>
                </button>
                <button onclick="switchTab('notification')" class="config-tab">
                    <i class="fas fa-bell"></i>
                    <span>é€šçŸ¥</span>
                </button>
                <button onclick="switchTab('advanced')" class="config-tab">
                    <i class="fas fa-tools"></i>
                    <span>é«˜çº§</span>
                </button>
            </div>
        </div>
        
        <!-- æœåŠ¡å™¨é…ç½® -->
        <div id="server-section" class="config-section active">
            <div class="glass-card p-8">
                <h2 class="config-group-title">
                    <i class="fas fa-server text-blue-400"></i>
                    ğŸ–¥ï¸ æœåŠ¡å™¨é…ç½®
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="input-group">
                        <label>ğŸŒ ç›‘å¬åœ°å€</label>
                        <input type="text" id="server-host" class="input-field" placeholder="0.0.0.0">
                    </div>
                    <div class="input-group">
                        <label>ğŸ”Œ ç›‘å¬ç«¯å£</label>
                        <input type="number" id="server-port" class="input-field" placeholder="8080">
                    </div>
                    <div class="input-group">
                        <label>ğŸš€ è¿è¡Œæ¨¡å¼</label>
                        <select id="server-mode" class="input-field">
                            <option value="debug">è°ƒè¯•æ¨¡å¼</option>
                            <option value="release">ç”Ÿäº§æ¨¡å¼</option>
                            <option value="test">æµ‹è¯•æ¨¡å¼</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>â±ï¸ è¯»å–è¶…æ—¶</label>
                        <input type="text" id="server-read-timeout" class="input-field" placeholder="30s">
                    </div>
                    <div class="input-group">
                        <label>â±ï¸ å†™å…¥è¶…æ—¶</label>
                        <input type="text" id="server-write-timeout" class="input-field" placeholder="30s">
                    </div>
                    <div class="input-group">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="server-enable-cors" class="rounded">
                            <span>ğŸ”“ å¯ç”¨ CORS</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ•°æ®åº“é…ç½® -->
        <div id="database-section" class="config-section">
            <div class="glass-card p-8">
                <h2 class="config-group-title">
                    <i class="fas fa-database text-green-400"></i>
                    ğŸ—„ï¸ æ•°æ®åº“é…ç½®
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="input-group">
                        <label>ğŸ  æ•°æ®åº“ä¸»æœº</label>
                        <input type="text" id="database-host" class="input-field" placeholder="localhost">
                    </div>
                    <div class="input-group">
                        <label>ğŸ”Œ æ•°æ®åº“ç«¯å£</label>
                        <input type="number" id="database-port" class="input-field" placeholder="5432">
                    </div>
                    <div class="input-group">
                        <label>ğŸ‘¤ ç”¨æˆ·å</label>
                        <input type="text" id="database-user" class="input-field" placeholder="nsfw">
                    </div>
                    <div class="input-group">
                        <label>ğŸ”‘ å¯†ç </label>
                        <input type="password" id="database-password" class="input-field" placeholder="å¯†ç ">
                    </div>
                    <div class="input-group">
                        <label>ğŸ“š æ•°æ®åº“åç§°</label>
                        <input type="text" id="database-dbname" class="input-field" placeholder="nsfw_db">
                    </div>
                    <div class="input-group">
                        <label>ğŸ”’ SSLæ¨¡å¼</label>
                        <select id="database-sslmode" class="input-field">
                            <option value="disable">ç¦ç”¨</option>
                            <option value="require">è¦æ±‚</option>
                            <option value="verify-ca">éªŒè¯CA</option>
                            <option value="verify-full">å®Œå…¨éªŒè¯</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>ğŸ”— æœ€å¤§è¿æ¥æ•°</label>
                        <input type="number" id="database-max-open-conns" class="input-field" placeholder="25">
                    </div>
                    <div class="input-group">
                        <label>ğŸ’¤ æœ€å¤§ç©ºé—²è¿æ¥æ•°</label>
                        <input type="number" id="database-max-idle-conns" class="input-field" placeholder="10">
                    </div>
                    <div class="input-group">
                        <label>â³ è¿æ¥æœ€å¤§ç”Ÿå­˜æ—¶é—´ï¼ˆç§’ï¼‰</label>
                        <input type="number" id="database-max-lifetime" class="input-field" placeholder="3600">
                    </div>
                </div>
                <div class="mt-6">
                    <button onclick="testDatabaseConnection()" class="btn btn-success">
                        <i class="fas fa-plug"></i>
                        æµ‹è¯•æ•°æ®åº“è¿æ¥
                    </button>
                    <div id="database-test-result" class="test-result"></div>
                </div>
            </div>
        </div>
        
        <!-- Redisé…ç½® -->
        <div id="redis-section" class="config-section">
            <div class="glass-card p-8">
                <h2 class="config-group-title">
                    <i class="fas fa-memory text-red-400"></i>
                    ğŸ’¾ Redisé…ç½®
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="input-group">
                        <label>ğŸ  Redisä¸»æœº</label>
                        <input type="text" id="redis-host" class="input-field" placeholder="localhost">
                    </div>
                    <div class="input-group">
                        <label>ğŸ”Œ Redisç«¯å£</label>
                        <input type="number" id="redis-port" class="input-field" placeholder="6379">
                    </div>
                    <div class="input-group">
                        <label>ğŸ”‘ Rediså¯†ç </label>
                        <input type="password" id="redis-password" class="input-field" placeholder="Rediså¯†ç ï¼ˆå¯é€‰ï¼‰">
                    </div>
                    <div class="input-group">
                        <label>ğŸ“š æ•°æ®åº“ç¼–å·</label>
                        <input type="number" id="redis-db" class="input-field" placeholder="0">
                    </div>
                    <div class="input-group">
                        <label>ğŸ”— è¿æ¥æ± å¤§å°</label>
                        <input type="number" id="redis-pool-size" class="input-field" placeholder="10">
                    </div>
                    <div class="input-group">
                        <label>ğŸ’¤ æœ€å°ç©ºé—²è¿æ¥æ•°</label>
                        <input type="number" id="redis-min-idle-conns" class="input-field" placeholder="5">
                    </div>
                </div>
                <div class="mt-6">
                    <button onclick="testRedisConnection()" class="btn btn-danger">
                        <i class="fas fa-plug"></i>
                        æµ‹è¯•Redisè¿æ¥
                    </button>
                    <div id="redis-test-result" class="test-result"></div>
                </div>
            </div>
        </div>
        
        <!-- Telegramé…ç½® -->
        <div id="telegram-section" class="config-section">
            <div class="glass-card p-8">
                <h2 class="config-group-title">
                    <i class="fab fa-telegram text-blue-400"></i>
                    ğŸ’¬ Telegram Boté…ç½®
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="input-group md:col-span-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="telegram-enabled" class="rounded">
                            <span>ğŸ¤– å¯ç”¨ Telegram Bot</span>
                        </label>
                    </div>
                    <div class="input-group">
                        <label>ğŸ” Bot Token</label>
                        <input type="password" id="telegram-token" class="input-field" placeholder="ä» @BotFather è·å–">
                    </div>
                    <div class="input-group">
                        <label>ğŸ”— Webhook URLï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="telegram-webhook-url" class="input-field" placeholder="https://your-domain.com/webhook">
                    </div>
                    <div class="input-group md:col-span-2">
                        <label>ğŸ‘® ç®¡ç†å‘˜ç”¨æˆ·IDåˆ—è¡¨</label>
                        <textarea id="telegram-admin-ids" class="input-field" rows="3" placeholder="æ¯è¡Œè¾“å…¥ä¸€ä¸ªç®¡ç†å‘˜ID&#10;ä¾‹å¦‚ï¼š&#10;123456789&#10;987654321"></textarea>
                        <small class="text-muted">æ¯è¡Œä¸€ä¸ªTelegramç”¨æˆ·IDï¼Œå¯ä»¥é€šè¿‡Botå‘é€ /id å‘½ä»¤è·å–</small>
                    </div>
                </div>
                
                <!-- Telegramé€šçŸ¥è®¾ç½® -->
                <div class="config-group mt-4">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-bell text-yellow-400"></i>
                        ğŸ”” é€šçŸ¥è®¾ç½®
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="notification-telegram-enabled" class="rounded">
                                <span>ğŸ”” å¯ç”¨Telegramé€šçŸ¥</span>
                            </label>
                        </div>
                        <div class="input-group">
                            <label>ğŸ’¬ é€šçŸ¥èŠå¤©ID</label>
                            <input type="text" id="notification-telegram-chat-id" class="input-field" placeholder="èŠå¤©IDæˆ–é¢‘é“ID">
                            <small class="text-muted">å¯ä»¥æ˜¯ç¾¤ç»„IDã€é¢‘é“IDæˆ–ç§èŠID</small>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex gap-4">
                    <button onclick="testTelegramConnection()" class="btn btn-primary">
                        <i class="fas fa-plug"></i>
                        æµ‹è¯•è¿æ¥
                    </button>
                    <button onclick="testTelegramNotification()" class="btn btn-success">
                        <i class="fas fa-paper-plane"></i>
                        å‘é€æµ‹è¯•é€šçŸ¥
                    </button>
                    <div id="telegram-test-result" class="test-result mt-4"></div>
                </div>
            </div>
        </div>
        
        <!-- çˆ¬è™«é…ç½® -->
        <div id="crawler-section" class="config-section">
            <div class="glass-card p-8">
                <h2 class="config-group-title">
                    <i class="fas fa-spider text-purple-400"></i>
                    ğŸ•·ï¸ çˆ¬è™«é…ç½®
                </h2>
                <div class="space-y-6">
                    <div class="input-group">
                        <label>ğŸ­ User-Agent åˆ—è¡¨</label>
                        <div id="crawler-user-agents" class="array-input mb-4">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <button type="button" onclick="addUserAgent()" class="btn btn-sm btn-secondary">
                            <i class="fas fa-plus"></i>
                            æ·»åŠ User-Agent
                        </button>
                    </div>
                    
                    <div class="input-group">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="crawler-proxy-enabled" class="rounded">
                            <span>ğŸŒ å¯ç”¨ä»£ç†</span>
                        </label>
                    </div>
                    
                    <div class="input-group">
                        <label>ğŸ”— ä»£ç†åˆ—è¡¨</label>
                        <div id="crawler-proxy-list" class="array-input mb-4">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <button type="button" onclick="addProxy()" class="btn btn-sm btn-secondary">
                            <i class="fas fa-plus"></i>
                            æ·»åŠ ä»£ç†
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="input-group">
                            <label>â±ï¸ è¯·æ±‚é—´éš”</label>
                            <input type="text" id="crawler-request-delay" class="input-field" placeholder="2s">
                        </div>
                        <div class="input-group">
                            <label>ğŸ”„ é‡è¯•æ¬¡æ•°</label>
                            <input type="number" id="crawler-retry-count" class="input-field" placeholder="3">
                        </div>
                        <div class="input-group">
                            <label>â³ è¯·æ±‚è¶…æ—¶</label>
                            <input type="text" id="crawler-timeout" class="input-field" placeholder="30s">
                        </div>
                        <div class="input-group">
                            <label>ğŸš€ æœ€å¤§å¹¶å‘æ•°</label>
                            <input type="number" id="crawler-concurrent-max" class="input-field" placeholder="5">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åª’ä½“åº“é…ç½® -->
        <div id="media-section" class="config-section">
            <div class="glass-card p-8">
                <h2 class="config-group-title">
                    <i class="fas fa-folder text-yellow-400"></i>
                    ğŸ“ åª’ä½“åº“é…ç½®
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="input-group">
                        <label>ğŸ“‚ åª’ä½“åº“åŸºç¡€è·¯å¾„</label>
                        <input type="text" id="media-base-path" class="input-field" placeholder="/MediaCenter">
                    </div>
                    <div class="input-group">
                        <label>ğŸ”„ æ‰«æé—´éš”ï¼ˆå°æ—¶ï¼‰</label>
                        <input type="number" id="media-scan-interval" class="input-field" placeholder="24">
                    </div>
                    <div class="input-group md:col-span-2">
                        <label>ğŸ“ æ”¯æŒçš„æ–‡ä»¶æ‰©å±•å</label>
                        <div id="media-supported-exts" class="array-input mb-4">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <button type="button" onclick="addMediaExt()" class="btn btn-sm btn-warning">
                            <i class="fas fa-plus"></i>
                            æ·»åŠ æ‰©å±•å
                        </button>
                    </div>
                    <div class="input-group">
                        <label>ğŸ“ æœ€å°æ–‡ä»¶å¤§å°ï¼ˆMBï¼‰</label>
                        <input type="number" id="media-min-file-size" class="input-field" placeholder="100">
                    </div>
                    <div class="input-group">
                        <label>ğŸ“ æœ€å¤§æ–‡ä»¶å¤§å°ï¼ˆMBï¼‰</label>
                        <input type="number" id="media-max-file-size" class="input-field" placeholder="10240">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç§å­ä¸‹è½½é…ç½® -->
        <div id="torrent-section" class="config-section">
            <div class="glass-card p-8">
                <h2 class="config-group-title">
                    <i class="fas fa-download text-cyan-400"></i>
                    ğŸ“¥ ç§å­ä¸‹è½½é…ç½®
                </h2>
                
                <!-- Jacketté…ç½® -->
                <div class="config-group">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-search text-blue-400"></i>
                        ğŸ” Jacketté…ç½®
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label>ğŸ  Jackettä¸»æœºåœ°å€</label>
                            <input type="text" id="torrent-jackett-host" class="input-field" placeholder="http://jackett:9117">
                        </div>
                        <div class="input-group">
                            <label>ğŸ”‘ APIå¯†é’¥</label>
                            <input type="password" id="torrent-jackett-api-key" class="input-field" placeholder="Jackett APIå¯†é’¥">
                        </div>
                    </div>
                    <button onclick="testJackettConnection()" class="btn btn-sm btn-primary mt-4">
                        <i class="fas fa-plug"></i>
                        æµ‹è¯•è¿æ¥
                    </button>
                    <div id="jackett-test-result" class="test-result"></div>
                </div>
                
                <!-- qBittorrenté…ç½® -->
                <div class="config-group">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-download text-green-400"></i>
                        ğŸ’¾ qBittorrenté…ç½®
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="input-group">
                            <label>ğŸ  ä¸»æœºåœ°å€</label>
                            <input type="text" id="torrent-qbittorrent-host" class="input-field" placeholder="http://qbittorrent:8080">
                        </div>
                        <div class="input-group">
                            <label>ğŸ‘¤ ç”¨æˆ·å</label>
                            <input type="text" id="torrent-qbittorrent-username" class="input-field" placeholder="admin">
                        </div>
                        <div class="input-group">
                            <label>ğŸ”‘ å¯†ç </label>
                            <input type="password" id="torrent-qbittorrent-password" class="input-field" placeholder="å¯†ç ">
                        </div>
                        <div class="input-group lg:col-span-3">
                            <label>ğŸ“‚ ä¸‹è½½ç›®å½•</label>
                            <input type="text" id="torrent-qbittorrent-download-dir" class="input-field" placeholder="/downloads">
                        </div>
                    </div>
                    <button onclick="testQBittorrentConnection()" class="btn btn-sm btn-success mt-4">
                        <i class="fas fa-plug"></i>
                        æµ‹è¯•è¿æ¥
                    </button>
                    <div id="qbittorrent-test-result" class="test-result"></div>
                </div>
            </div>
        </div>
        
        <!-- è®¢é˜…ä¸‹è½½é…ç½® -->
        <div id="subscription-section" class="config-section">
            <div class="glass-card p-8">
                <h2 class="config-group-title">
                    <i class="fas fa-calendar-check text-purple-400"></i>
                    ğŸ“… è®¢é˜…ä¸‹è½½é…ç½®
                </h2>
                
                <!-- æ—¥æ¦œè®¢é˜… -->
                <div class="config-group">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-calendar-day text-blue-400"></i>
                        ğŸ“… æ—¥æ¦œè®¢é˜…
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="input-group">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="daily-enabled" class="checkbox-input">
                                å¯ç”¨æ—¥æ¦œè®¢é˜…
                            </label>
                        </div>
                        <div class="input-group">
                            <label>â° å°æ—¶é™åˆ¶</label>
                            <input type="number" id="daily-hourly-limit" class="input-field" placeholder="10" min="1" max="100">
                        </div>
                        <div class="input-group">
                            <label>ğŸ“… æ—¥é™åˆ¶</label>
                            <input type="number" id="daily-daily-limit" class="input-field" placeholder="50" min="1" max="500">
                        </div>
                    </div>
                    <div class="mt-4 flex gap-3">
                        <button onclick="saveSubscription('daily')" class="btn btn-sm btn-success">
                            <i class="fas fa-save"></i>
                            ä¿å­˜è®¾ç½®
                        </button>
                        <button onclick="runSubscription('daily')" class="btn btn-sm btn-primary">
                            <i class="fas fa-play"></i>
                            ç«‹å³æ‰§è¡Œ
                        </button>
                        <button onclick="getSubscriptionStatus('daily')" class="btn btn-sm btn-info">
                            <i class="fas fa-info-circle"></i>
                            æŸ¥çœ‹çŠ¶æ€
                        </button>
                    </div>
                    <div id="daily-status" class="test-result mt-3"></div>
                </div>
                
                <!-- å‘¨æ¦œè®¢é˜… -->
                <div class="config-group">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-calendar-week text-green-400"></i>
                        ğŸ“† å‘¨æ¦œè®¢é˜…
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="input-group">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="weekly-enabled" class="checkbox-input">
                                å¯ç”¨å‘¨æ¦œè®¢é˜…
                            </label>
                        </div>
                        <div class="input-group">
                            <label>â° å°æ—¶é™åˆ¶</label>
                            <input type="number" id="weekly-hourly-limit" class="input-field" placeholder="10" min="1" max="100">
                        </div>
                        <div class="input-group">
                            <label>ğŸ“… æ—¥é™åˆ¶</label>
                            <input type="number" id="weekly-daily-limit" class="input-field" placeholder="50" min="1" max="500">
                        </div>
                    </div>
                    <div class="mt-4 flex gap-3">
                        <button onclick="saveSubscription('weekly')" class="btn btn-sm btn-success">
                            <i class="fas fa-save"></i>
                            ä¿å­˜è®¾ç½®
                        </button>
                        <button onclick="runSubscription('weekly')" class="btn btn-sm btn-primary">
                            <i class="fas fa-play"></i>
                            ç«‹å³æ‰§è¡Œ
                        </button>
                        <button onclick="getSubscriptionStatus('weekly')" class="btn btn-sm btn-info">
                            <i class="fas fa-info-circle"></i>
                            æŸ¥çœ‹çŠ¶æ€
                        </button>
                    </div>
                    <div id="weekly-status" class="test-result mt-3"></div>
                </div>
                
                <!-- æœˆæ¦œè®¢é˜… -->
                <div class="config-group">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-calendar-alt text-orange-400"></i>
                        ğŸ“Š æœˆæ¦œè®¢é˜…
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="input-group">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="monthly-enabled" class="checkbox-input">
                                å¯ç”¨æœˆæ¦œè®¢é˜…
                            </label>
                        </div>
                        <div class="input-group">
                            <label>â° å°æ—¶é™åˆ¶</label>
                            <input type="number" id="monthly-hourly-limit" class="input-field" placeholder="10" min="1" max="100">
                        </div>
                        <div class="input-group">
                            <label>ğŸ“… æ—¥é™åˆ¶</label>
                            <input type="number" id="monthly-daily-limit" class="input-field" placeholder="50" min="1" max="500">
                        </div>
                    </div>
                    <div class="mt-4 flex gap-3">
                        <button onclick="saveSubscription('monthly')" class="btn btn-sm btn-success">
                            <i class="fas fa-save"></i>
                            ä¿å­˜è®¾ç½®
                        </button>
                        <button onclick="runSubscription('monthly')" class="btn btn-sm btn-primary">
                            <i class="fas fa-play"></i>
                            ç«‹å³æ‰§è¡Œ
                        </button>
                        <button onclick="getSubscriptionStatus('monthly')" class="btn btn-sm btn-info">
                            <i class="fas fa-info-circle"></i>
                            æŸ¥çœ‹çŠ¶æ€
                        </button>
                    </div>
                    <div id="monthly-status" class="test-result mt-3"></div>
                </div>
                
                <!-- å…¨éƒ¨è®¢é˜…æ“ä½œ -->
                <div class="config-group">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-tasks text-cyan-400"></i>
                        ğŸ›ï¸ å…¨éƒ¨è®¢é˜…æ“ä½œ
                    </h3>
                    <div class="flex gap-3">
                        <button onclick="loadAllSubscriptions()" class="btn btn-sm btn-secondary">
                            <i class="fas fa-sync-alt"></i>
                            åˆ·æ–°é…ç½®
                        </button>
                        <button onclick="runAllSubscriptions()" class="btn btn-sm btn-warning">
                            <i class="fas fa-play-circle"></i>
                            æ‰§è¡Œå…¨éƒ¨è®¢é˜…
                        </button>
                        <button onclick="viewDownloadTasks()" class="btn btn-sm btn-info">
                            <i class="fas fa-list"></i>
                            æŸ¥çœ‹ä¸‹è½½ä»»åŠ¡
                        </button>
                    </div>
                    <div id="all-subscriptions-status" class="test-result mt-3"></div>
                </div>
            </div>
        </div>
        
        <!-- å®‰å…¨é…ç½® -->
        <div id="security-section" class="config-section">
            <div class="glass-card p-8">
                <h2 class="config-group-title">
                    <i class="fas fa-shield-alt text-green-400"></i>
                    ğŸ›¡ï¸ å®‰å…¨é…ç½®
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="input-group">
                        <label>ğŸ” JWTå¯†é’¥</label>
                        <input type="password" id="security-jwt-secret" class="input-field" placeholder="è¯·è®¾ç½®å®‰å…¨çš„å¯†é’¥">
                    </div>
                    <div class="input-group">
                        <label>â° JWTè¿‡æœŸæ—¶é—´</label>
                        <input type="text" id="security-jwt-expiry" class="input-field" placeholder="24h">
                    </div>
                    <div class="input-group">
                        <label>ğŸ§‚ å¯†ç ç›å€¼</label>
                        <input type="password" id="security-password-salt" class="input-field" placeholder="å¯†ç ç›å€¼">
                    </div>
                    <div class="input-group">
                        <label>ğŸš¦ APIé™æµï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰</label>
                        <input type="number" id="security-rate-limit-rps" class="input-field" placeholder="100">
                    </div>
                    <div class="input-group md:col-span-2">
                        <label>ğŸ“‹ å…è®¸è®¿é—®çš„IPåˆ—è¡¨</label>
                        <div id="security-allowed-ips" class="array-input mb-4">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <button type="button" onclick="addAllowedIP()" class="btn btn-sm btn-success">
                            <i class="fas fa-plus"></i>
                            æ·»åŠ IP
                        </button>
                    </div>
                    <div class="input-group">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="security-enable-auth" class="rounded">
                            <span>ğŸ”’ å¯ç”¨èº«ä»½éªŒè¯</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é€šçŸ¥é…ç½® -->
        <div id="notification-section" class="config-section">
            <div class="glass-card p-8">
                <h2 class="config-group-title">
                    <i class="fas fa-bell text-orange-400"></i>
                    ğŸ”” é€šçŸ¥é…ç½®
                </h2>
                
                <!-- é‚®ä»¶é€šçŸ¥ -->
                <div class="config-group">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-envelope text-green-400"></i>
                        ğŸ“§ é‚®ä»¶é€šçŸ¥
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="input-group lg:col-span-3">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="notification-email-enabled" class="rounded">
                                <span>ğŸ“® å¯ç”¨é‚®ä»¶é€šçŸ¥</span>
                            </label>
                        </div>
                        <div class="input-group">
                            <label>ğŸ“¬ SMTPæœåŠ¡å™¨</label>
                            <input type="text" id="notification-email-smtp-host" class="input-field" placeholder="smtp.gmail.com">
                        </div>
                        <div class="input-group">
                            <label>ğŸ”Œ SMTPç«¯å£</label>
                            <input type="number" id="notification-email-smtp-port" class="input-field" placeholder="587">
                        </div>
                        <div class="input-group">
                            <label>ğŸ‘¤ é‚®ç®±ç”¨æˆ·å</label>
                            <input type="text" id="notification-email-username" class="input-field" placeholder="ç”¨æˆ·å">
                        </div>
                        <div class="input-group">
                            <label>ğŸ”‘ é‚®ç®±å¯†ç </label>
                            <input type="password" id="notification-email-password" class="input-field" placeholder="å¯†ç ">
                        </div>
                        <div class="input-group">
                            <label>ğŸ“¤ å‘ä»¶äººé‚®ç®±</label>
                            <input type="email" id="notification-email-from" class="input-field" placeholder="sender@example.com">
                        </div>
                        <div class="input-group lg:col-span-3">
                            <label>ğŸ“¥ æ”¶ä»¶äººé‚®ç®±åˆ—è¡¨</label>
                            <div id="notification-email-to" class="array-input mb-4">
                                <!-- åŠ¨æ€ç”Ÿæˆ -->
                            </div>
                            <button type="button" onclick="addEmailTo()" class="btn btn-sm btn-success">
                                <i class="fas fa-plus"></i>
                                æ·»åŠ æ”¶ä»¶äºº
                            </button>
                        </div>
                    </div>
                    <button onclick="testEmailConnection()" class="btn btn-sm btn-success mt-4">
                        <i class="fas fa-plug"></i>
                        æµ‹è¯•é‚®ä»¶è¿æ¥
                    </button>
                    <div id="email-test-result" class="test-result"></div>
                </div>
            </div>
        </div>
        
        <!-- é«˜çº§é…ç½® -->
        <div id="advanced-section" class="config-section">
            <div class="glass-card p-8">
                <h2 class="config-group-title">
                    <i class="fas fa-tools text-gray-400"></i>
                    ğŸ”§ é«˜çº§é…ç½®
                </h2>
                
                <!-- æ—¥å¿—é…ç½® -->
                <div class="config-group">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-file-alt text-yellow-400"></i>
                        ğŸ“ æ—¥å¿—é…ç½®
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="input-group">
                            <label>ğŸ“Š æ—¥å¿—çº§åˆ«</label>
                            <select id="log-level" class="input-field">
                                <option value="debug">è°ƒè¯•</option>
                                <option value="info">ä¿¡æ¯</option>
                                <option value="warn">è­¦å‘Š</option>
                                <option value="error">é”™è¯¯</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>ğŸ“„ æ—¥å¿—æ ¼å¼</label>
                            <select id="log-format" class="input-field">
                                <option value="json">JSONæ ¼å¼</option>
                                <option value="text">æ–‡æœ¬æ ¼å¼</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>ğŸ’¾ è¾“å‡ºç›®æ ‡</label>
                            <select id="log-output" class="input-field">
                                <option value="stdout">æ ‡å‡†è¾“å‡º</option>
                                <option value="file">æ–‡ä»¶</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>ğŸ“ æ—¥å¿—æ–‡ä»¶è·¯å¾„</label>
                            <input type="text" id="log-filename" class="input-field" placeholder="logs/nsfw-go.log">
                        </div>
                        <div class="input-group">
                            <label>ğŸ“ å•ä¸ªæ–‡ä»¶æœ€å¤§å¤§å°ï¼ˆMBï¼‰</label>
                            <input type="number" id="log-max-size" class="input-field" placeholder="100">
                        </div>
                        <div class="input-group">
                            <label>ğŸ—‚ï¸ ä¿ç•™æ–‡ä»¶æ•°é‡</label>
                            <input type="number" id="log-max-backups" class="input-field" placeholder="7">
                        </div>
                    </div>
                </div>
                
                <!-- å¤‡ä»½ç®¡ç† -->
                <div class="config-group">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-archive text-blue-400"></i>
                        ğŸ’¾ é…ç½®å¤‡ä»½ç®¡ç†
                    </h3>
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-muted">ç®¡ç†é…ç½®æ–‡ä»¶å¤‡ä»½å’Œæ¢å¤</p>
                        <div class="flex gap-2">
                            <button onclick="createBackup()" class="btn btn-sm btn-success">
                                <i class="fas fa-save"></i>
                                åˆ›å»ºå¤‡ä»½
                            </button>
                            <button onclick="loadBackups()" class="btn btn-sm btn-primary">
                                <i class="fas fa-sync-alt"></i>
                                åˆ·æ–°åˆ—è¡¨
                            </button>
                        </div>
                    </div>
                    <div id="backup-list" class="max-h-64 overflow-y-auto">
                        <!-- å¤‡ä»½åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        <div class="empty-state flex-center p-8">
                            <div class="text-center">
                                <i class="fas fa-archive empty-icon text-4xl mb-2"></i>
                                <p class="text-muted">æ­£åœ¨åŠ è½½å¤‡ä»½åˆ—è¡¨...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
    <button id="backToTop" onclick="scrollToTop()" class="fixed bottom-8 right-8 btn btn-primary rounded-full w-12 h-12 hidden">
        <i class="fas fa-arrow-up"></i>
    </button>
    
    <script src="static/js/components.js"></script>
    <script src="static/js/modern-nav.js"></script>
    <script src="static/js/config.js"></script>
    <script>
        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            loadAllSubscriptions(); // åŠ è½½è®¢é˜…é…ç½®
            
            // å¯åŠ¨è®¢é˜…çŠ¶æ€è‡ªåŠ¨æ›´æ–°
            startSubscriptionStatusUpdates();
            
            // ç›‘å¬æ»šåŠ¨äº‹ä»¶
            window.addEventListener('scroll', () => {
                const backToTop = document.getElementById('backToTop');
                if (window.scrollY > 300) {
                    backToTop.classList.remove('hidden');
                } else {
                    backToTop.classList.add('hidden');
                }
            });
        });
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', function() {
            stopSubscriptionStatusUpdates();
        });
        
        // ========== è®¢é˜…ç®¡ç†åŠŸèƒ½ ==========
        
        // åŠ è½½æ‰€æœ‰è®¢é˜…é…ç½®
        async function loadAllSubscriptions() {
            try {
                const response = await fetch('/api/v1/rankings/subscriptions');
                const data = await response.json();
                
                if (data.success && data.data) {
                    data.data.forEach(subscription => {
                        updateSubscriptionUI(subscription.rank_type, subscription);
                    });
                    components.showNotification('âœ… è®¢é˜…é…ç½®åŠ è½½æˆåŠŸ', 'success');
                } else {
                    throw new Error(data.error || 'åŠ è½½è®¢é˜…é…ç½®å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½è®¢é˜…é…ç½®å¤±è´¥:', error);
                components.showNotification('âŒ åŠ è½½è®¢é˜…é…ç½®å¤±è´¥', 'error');
            }
        }
        
        // æ›´æ–°è®¢é˜…UI
        function updateSubscriptionUI(rankType, subscription) {
            document.getElementById(`${rankType}-enabled`).checked = subscription.enabled;
            document.getElementById(`${rankType}-hourly-limit`).value = subscription.hourly_limit;
            document.getElementById(`${rankType}-daily-limit`).value = subscription.daily_limit;
        }
        
        // ä¿å­˜è®¢é˜…é…ç½®
        async function saveSubscription(rankType) {
            try {
                const enabled = document.getElementById(`${rankType}-enabled`).checked;
                const hourlyLimit = parseInt(document.getElementById(`${rankType}-hourly-limit`).value) || 10;
                const dailyLimit = parseInt(document.getElementById(`${rankType}-daily-limit`).value) || 50;
                
                const response = await fetch(`/api/v1/rankings/subscription/${rankType}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        enabled: enabled,
                        hourly_limit: hourlyLimit,
                        daily_limit: dailyLimit
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    components.showNotification(`âœ… ${rankType}æ¦œè®¢é˜…é…ç½®ä¿å­˜æˆåŠŸ`, 'success');
                } else {
                    throw new Error(data.error || 'ä¿å­˜é…ç½®å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜è®¢é˜…é…ç½®å¤±è´¥:', error);
                components.showNotification(`âŒ ä¿å­˜${rankType}æ¦œé…ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ‰§è¡Œè®¢é˜…ä¸‹è½½
        async function runSubscription(rankType) {
            try {
                components.showNotification(`ğŸš€ æ­£åœ¨æ‰§è¡Œ${rankType}æ¦œè®¢é˜…ä¸‹è½½...`, 'info');
                
                const response = await fetch(`/api/v1/rankings/subscription/${rankType}/run`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    components.showNotification(`âœ… ${rankType}æ¦œè®¢é˜…ä¸‹è½½å·²å¯åŠ¨`, 'success');
                    // å»¶è¿Ÿè·å–çŠ¶æ€æ›´æ–°
                    setTimeout(() => getSubscriptionStatus(rankType), 2000);
                } else {
                    throw new Error(data.error || 'æ‰§è¡Œè®¢é˜…ä¸‹è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('æ‰§è¡Œè®¢é˜…ä¸‹è½½å¤±è´¥:', error);
                components.showNotification(`âŒ æ‰§è¡Œ${rankType}æ¦œè®¢é˜…å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // è·å–è®¢é˜…çŠ¶æ€
        async function getSubscriptionStatus(rankType, showNotification = true) {
            try {
                const response = await fetch(`/api/v1/rankings/subscription/${rankType}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const status = data.data;
                    const statusElement = document.getElementById(`${rankType}-status`);
                    const rankTypeNames = { daily: 'æ—¥æ¦œ', weekly: 'å‘¨æ¦œ', monthly: 'æœˆæ¦œ' };
                    
                    // æ ¹æ®å‰©ä½™é¢åº¦è®¾ç½®çŠ¶æ€é¢œè‰²
                    const isWarning = (status.hourly_limit - status.hourly_used) <= 2 || (status.daily_limit - status.daily_used) <= 5;
                    const isFull = !status.can_download;
                    
                    statusElement.className = `test-result ${isFull ? 'error' : isWarning ? 'warning' : 'success'}`;
                    statusElement.style.display = 'block';
                    
                    const progressBar = (used, total) => {
                        const percentage = total > 0 ? Math.round((used / total) * 100) : 0;
                        const color = percentage >= 90 ? 'red' : percentage >= 70 ? 'orange' : 'green';
                        return `<div style="background: #333; border-radius: 4px; overflow: hidden; height: 8px; margin: 2px 0;">
                                    <div style="background: ${color}; width: ${percentage}%; height: 100%; transition: width 0.3s ease;"></div>
                                </div>`;
                    };
                    
                    statusElement.innerHTML = `
                        <div class="text-sm space-y-2">
                            <p><strong>ğŸ“Š ${rankTypeNames[rankType]}çŠ¶æ€</strong> <span class="text-xs text-gray-400">(${new Date().toLocaleTimeString()})</span></p>
                            <div>
                                <p>â° å°æ—¶é¢åº¦ï¼š${status.hourly_used} / ${status.hourly_limit} 
                                   <span class="text-xs ${status.hourly_used >= status.hourly_limit ? 'text-red-400' : 'text-green-400'}">
                                       (${status.hourly_limit - status.hourly_used}å‰©ä½™)
                                   </span>
                                </p>
                                ${progressBar(status.hourly_used, status.hourly_limit)}
                            </div>
                            <div>
                                <p>ğŸ“… æ—¥é¢åº¦ï¼š${status.daily_used} / ${status.daily_limit}
                                   <span class="text-xs ${status.daily_used >= status.daily_limit ? 'text-red-400' : 'text-green-400'}">
                                       (${status.daily_limit - status.daily_used}å‰©ä½™)
                                   </span>
                                </p>
                                ${progressBar(status.daily_used, status.daily_limit)}
                            </div>
                            <p>ğŸš¦ çŠ¶æ€ï¼š${status.can_download ? 'âœ… å¯ä¸‹è½½' : 'âŒ å·²è¾¾é™åˆ¶'}</p>
                        </div>
                    `;
                    
                    if (showNotification && !status.can_download) {
                        components.showNotification(`âš ï¸ ${rankTypeNames[rankType]}å·²è¾¾ä¸‹è½½é™åˆ¶`, 'warning');
                    }
                } else {
                    throw new Error(data.error || 'è·å–çŠ¶æ€å¤±è´¥');
                }
            } catch (error) {
                console.error('è·å–è®¢é˜…çŠ¶æ€å¤±è´¥:', error);
                const statusElement = document.getElementById(`${rankType}-status`);
                statusElement.className = 'test-result error';
                statusElement.style.display = 'block';
                statusElement.innerHTML = `
                    <div class="text-sm">
                        <p>âŒ è·å–çŠ¶æ€å¤±è´¥</p>
                        <p class="text-xs text-gray-400">${error.message}</p>
                        <button onclick="getSubscriptionStatus('${rankType}')" class="btn btn-xs btn-secondary mt-2">
                            <i class="fas fa-redo"></i> é‡è¯•
                        </button>
                    </div>
                `;
            }
        }
        
        // æ‰§è¡Œæ‰€æœ‰è®¢é˜…
        async function runAllSubscriptions() {
            components.showNotification('ğŸš€ æ­£åœ¨æ‰§è¡Œæ‰€æœ‰è®¢é˜…...', 'info');
            
            const types = ['daily', 'weekly', 'monthly'];
            let successCount = 0;
            
            for (const type of types) {
                try {
                    const response = await fetch(`/api/v1/rankings/subscription/${type}/run`, {
                        method: 'POST'
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        successCount++;
                    }
                } catch (error) {
                    console.error(`æ‰§è¡Œ${type}æ¦œè®¢é˜…å¤±è´¥:`, error);
                }
                
                // é¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            if (successCount === types.length) {
                components.showNotification('âœ… æ‰€æœ‰è®¢é˜…å·²å¯åŠ¨å®Œæˆ', 'success');
            } else {
                components.showNotification(`âš ï¸ å¯åŠ¨å®Œæˆï¼ŒæˆåŠŸ: ${successCount}/${types.length}`, 'warning');
            }
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            const statusElement = document.getElementById('all-subscriptions-status');
            statusElement.className = `test-result ${successCount === types.length ? 'success' : 'warning'}`;
            statusElement.style.display = 'block';
            statusElement.innerHTML = `
                <div class="text-sm">
                    <p><strong>ğŸ“Š æ‰¹é‡æ‰§è¡Œç»“æœ: ${successCount}/${types.length}</strong></p>
                    <p class="text-xs text-gray-400">æ‰§è¡Œæ—¶é—´: ${new Date().toLocaleString()}</p>
                </div>
            `;
            
            // å»¶è¿Ÿåˆ·æ–°çŠ¶æ€
            setTimeout(() => {
                types.forEach(type => getSubscriptionStatus(type, false));
            }, 3000);
        }
        
        // æŸ¥çœ‹ä¸‹è½½ä»»åŠ¡
        async function viewDownloadTasks() {
            try {
                const response = await fetch('/api/v1/rankings/download-tasks?limit=20&source=subscription');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const tasks = data.data.tasks || [];
                    const total = data.data.total || 0;
                    
                    const allStatusElement = document.getElementById('all-subscriptions-status');
                    allStatusElement.style.display = 'block';
                    allStatusElement.className = 'test-result info';
                    
                    if (tasks.length === 0) {
                        allStatusElement.innerHTML = `
                            <div class="text-sm">
                                <p>ğŸ“ æš‚æ— è®¢é˜…ä¸‹è½½ä»»åŠ¡</p>
                                <p class="text-xs text-gray-400">å¯ä»¥ç‚¹å‡»"ç«‹å³æ‰§è¡Œ"æ¥åˆ›å»ºè®¢é˜…ä»»åŠ¡</p>
                            </div>
                        `;
                    } else {
                        const statusCounts = {};
                        tasks.forEach(task => {
                            statusCounts[task.status] = (statusCounts[task.status] || 0) + 1;
                        });
                        
                        const getStatusDisplay = (status) => {
                            const statusMap = {
                                'pending': 'â³ ç­‰å¾…ä¸­',
                                'searching': 'ğŸ” æœç´¢ä¸­', 
                                'found': 'âœ… å·²æ‰¾åˆ°',
                                'started': 'âš¡ å·²å¼€å§‹',
                                'progress': 'ğŸ“¥ ä¸‹è½½ä¸­',
                                'completed': 'âœ… å·²å®Œæˆ',
                                'failed': 'âŒ å¤±è´¥',
                                'cancelled': 'â¹ï¸ å·²å–æ¶ˆ'
                            };
                            return statusMap[status] || status;
                        };
                        
                        allStatusElement.innerHTML = `
                            <div class="text-sm">
                                <p><strong>ğŸ“‹ è®¢é˜…ä»»åŠ¡çŠ¶æ€ (${total}ä¸ª)</strong></p>
                                <div class="mt-2 grid grid-cols-2 gap-2 text-xs">
                                    ${Object.entries(statusCounts).map(([status, count]) => 
                                        `<p>${getStatusDisplay(status)}: ${count}ä¸ª</p>`
                                    ).join('')}
                                </div>
                                <div class="mt-3 space-y-1">
                                    <p class="text-xs font-semibold">ğŸ“‹ æœ€è¿‘ä»»åŠ¡ï¼š</p>
                                    ${tasks.slice(0, 5).map(task => `
                                        <p class="text-xs flex justify-between">
                                            <span class="font-mono">${task.code}</span>
                                            <span class="${task.status === 'completed' ? 'text-green-400' : task.status === 'failed' ? 'text-red-400' : 'text-yellow-400'}">
                                                ${getStatusDisplay(task.status)}
                                                ${task.progress > 0 ? ` (${Math.round(task.progress * 100)}%)` : ''}
                                            </span>
                                        </p>
                                    `).join('')}
                                    ${tasks.length > 5 ? `<p class="text-xs text-gray-400">...è¿˜æœ‰${tasks.length - 5}ä¸ªä»»åŠ¡</p>` : ''}
                                </div>
                                <div class="mt-3 flex gap-2">
                                    <button onclick="viewDownloadTasks()" class="btn btn-xs btn-secondary">
                                        <i class="fas fa-sync-alt"></i> åˆ·æ–°
                                    </button>
                                    <button onclick="window.open('/downloads.html', '_blank')" class="btn btn-xs btn-info">
                                        <i class="fas fa-external-link-alt"></i> è¯¦ç»†é¡µé¢
                                    </button>
                                </div>
                                <p class="mt-2 text-xs text-gray-400">æ›´æ–°æ—¶é—´: ${new Date().toLocaleString()}</p>
                            </div>
                        `;
                    }
                } else {
                    throw new Error(data.error || 'è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥');
                }
            } catch (error) {
                console.error('è·å–ä¸‹è½½ä»»åŠ¡å¤±è´¥:', error);
                const allStatusElement = document.getElementById('all-subscriptions-status');
                allStatusElement.style.display = 'block';
                allStatusElement.className = 'test-result error';
                allStatusElement.innerHTML = `
                    <div class="text-sm">
                        <p>âŒ è·å–ä»»åŠ¡å¤±è´¥: ${error.message}</p>
                        <button onclick="viewDownloadTasks()" class="btn btn-xs btn-secondary mt-2">
                            <i class="fas fa-redo"></i> é‡è¯•
                        </button>
                    </div>
                `;
            }
        }
        
        // è‡ªåŠ¨çŠ¶æ€æ›´æ–°æœºåˆ¶
        let subscriptionStatusInterval = null;
        
        function startSubscriptionStatusUpdates() {
            // å…ˆåœæ­¢ä¹‹å‰çš„å®šæ—¶å™¨
            if (subscriptionStatusInterval) {
                clearInterval(subscriptionStatusInterval);
            }
            
            // æ¯60ç§’è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡æ‰€æœ‰è®¢é˜…çŠ¶æ€ï¼ˆä»…åœ¨å¯è§æ—¶ï¼‰
            subscriptionStatusInterval = setInterval(() => {
                const rankTypes = ['daily', 'weekly', 'monthly'];
                rankTypes.forEach(rankType => {
                    const statusElement = document.getElementById(`${rankType}-status`);
                    if (statusElement && statusElement.style.display !== 'none') {
                        getSubscriptionStatus(rankType, false);
                    }
                });
            }, 60000); // 60ç§’
        }
        
        function stopSubscriptionStatusUpdates() {
            if (subscriptionStatusInterval) {
                clearInterval(subscriptionStatusInterval);
                subscriptionStatusInterval = null;
            }
        }
        
        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ§åˆ¶æ›´æ–°
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopSubscriptionStatusUpdates();
            } else {
                // é¡µé¢é‡æ–°å¯è§æ—¶å¯åŠ¨æ›´æ–°
                const subscriptionSection = document.getElementById('subscription-section');
                if (subscriptionSection && !subscriptionSection.classList.contains('hidden')) {
                    startSubscriptionStatusUpdates();
                }
            }
        });
        
        // è¿”å›é¡¶éƒ¨
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>