<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“¥ ä¸‹è½½ç®¡ç† - NSFW-Go</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="static/css/design-system.css">
    <link rel="stylesheet" href="static/css/components.css">
    <link rel="stylesheet" href="static/css/tailwind-fixes.css">
    <style>
        /* é¡µé¢ç‰¹å®šæ ·å¼ */
        .downloads-container {
            min-height: calc(100vh - 64px);
            padding: 2rem 1rem;
        }
        
        .progress-bar {
            transition: width 0.3s ease;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
        }
        
        .download-card {
            transition: all 0.3s ease;
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
        }
        
        .status-downloading {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }
        
        .status-completed {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }
        
        .status-seeding {
            background: rgba(168, 85, 247, 0.2);
            color: #c4b5fd;
        }
        
        .status-paused {
            background: rgba(251, 191, 36, 0.2);
            color: #fcd34d;
        }
        
        .status-queued {
            background: rgba(156, 163, 175, 0.2);
            color: #d1d5db;
        }
        
        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }
        
        /* é€Ÿåº¦æŒ‡ç¤ºå™¨ */
        .speed-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .speed-arrow-up {
            color: var(--success);
        }
        
        .speed-arrow-down {
            color: var(--primary);
        }
        
        /* æ–‡ä»¶åˆ—è¡¨ */
        .file-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .file-item {
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background 0.2s;
        }
        
        .file-item:hover {
            background: var(--bg-dark-tertiary);
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ å°†ç”±modern-nav.jsè‡ªåŠ¨æ’å…¥ -->
    
    <!-- ä¸»å†…å®¹åŒº -->
    <main class="page-container downloads-container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold mb-4">
                <span class="glow-text">ğŸ“¥ ä¸‹è½½ç®¡ç†</span>
            </h1>
            <p class="text-sm text-muted">ç®¡ç†æ‚¨çš„ç§å­ä¸‹è½½ä»»åŠ¡ï¼Œå®æ—¶æŸ¥çœ‹ä¸‹è½½è¿›åº¦ ğŸš€</p>
        </div>
        
        <!-- æ“ä½œæ  -->
        <div class="glass-card p-6 mb-6">
            <div class="flex flex-wrap gap-4 items-center justify-between">
                <div class="flex gap-3">
                    <button onclick="refreshDownloads()" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i>
                        <span>åˆ·æ–°åˆ—è¡¨</span>
                    </button>
                    <button onclick="showAddTorrent()" class="btn btn-secondary">
                        <i class="fas fa-plus"></i>
                        <span>æ·»åŠ ç§å­</span>
                    </button>
                    <button onclick="pauseAll()" class="btn btn-warning">
                        <i class="fas fa-pause"></i>
                        <span>å…¨éƒ¨æš‚åœ</span>
                    </button>
                    <button onclick="resumeAll()" class="btn btn-success">
                        <i class="fas fa-play"></i>
                        <span>å…¨éƒ¨ç»§ç»­</span>
                    </button>
                </div>
                
                <!-- ç­›é€‰é€‰é¡¹ -->
                <div class="flex gap-2">
                    <select id="statusFilter" onchange="filterDownloads()" class="input-field w-40">
                        <option value="all">ğŸ” å…¨éƒ¨çŠ¶æ€</option>
                        <option value="downloading">â¬‡ï¸ ä¸‹è½½ä¸­</option>
                        <option value="completed">âœ… å·²å®Œæˆ</option>
                        <option value="seeding">ğŸŒ± åšç§ä¸­</option>
                        <option value="paused">â¸ï¸ å·²æš‚åœ</option>
                        <option value="error">âŒ æœ‰é”™è¯¯</option>
                    </select>
                    
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="autoRefresh" checked class="rounded">
                        <span class="text-sm">ğŸ”„ è‡ªåŠ¨åˆ·æ–°</span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="stat-card">
                <div class="stat-icon bg-blue-500/20">
                    <i class="fas fa-download text-blue-400"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="stat-downloading">0</div>
                    <div class="stat-label">â¬‡ï¸ ä¸‹è½½ä¸­</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon bg-green-500/20">
                    <i class="fas fa-check text-green-400"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="stat-completed">0</div>
                    <div class="stat-label">âœ… å·²å®Œæˆ</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon bg-purple-500/20">
                    <i class="fas fa-seedling text-purple-400"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="stat-seeding">0</div>
                    <div class="stat-label">ğŸŒ± åšç§ä¸­</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon bg-yellow-500/20">
                    <i class="fas fa-hdd text-yellow-400"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="stat-size">0 GB</div>
                    <div class="stat-label">ğŸ’¾ æ€»å¤§å°</div>
                </div>
            </div>
        </div>
        
        <!-- å…¨å±€é€Ÿåº¦ä¿¡æ¯ -->
        <div class="glass-card p-4 mb-6">
            <div class="flex justify-around items-center">
                <div class="text-center">
                    <div class="speed-indicator text-lg font-bold">
                        <i class="fas fa-arrow-down speed-arrow-down"></i>
                        <span id="global-download-speed">0 MB/s</span>
                    </div>
                    <p class="text-sm text-muted mt-1">ä¸‹è½½é€Ÿåº¦</p>
                </div>
                <div class="text-center">
                    <div class="speed-indicator text-lg font-bold">
                        <i class="fas fa-arrow-up speed-arrow-up"></i>
                        <span id="global-upload-speed">0 MB/s</span>
                    </div>
                    <p class="text-sm text-muted mt-1">ä¸Šä¼ é€Ÿåº¦</p>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold">
                        <span id="active-torrents">0</span>
                    </div>
                    <p class="text-sm text-muted mt-1">æ´»åŠ¨ä»»åŠ¡</p>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold">
                        <span id="total-ratio">0.00</span>
                    </div>
                    <p class="text-sm text-muted mt-1">åˆ†äº«ç‡</p>
                </div>
            </div>
        </div>
        
        <!-- ä¸‹è½½åˆ—è¡¨ -->
        <div id="downloadsContainer">
            <!-- åˆå§‹åŠ è½½çŠ¶æ€ -->
            <div class="empty-state flex-center" style="min-height: 400px;">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin empty-icon text-6xl mb-4"></i>
                    <p class="text-lg text-muted">ğŸ”„ æ­£åœ¨åŠ è½½ä¸‹è½½åˆ—è¡¨...</p>
                </div>
            </div>
        </div>
    </main>
    
    <!-- æ·»åŠ ç§å­æ¨¡æ€æ¡† -->
    <div id="addTorrentModal" class="modal hidden">
        <div class="modal-content max-w-2xl">
            <div class="modal-header">
                <h3 class="text-lg font-semibold">â• æ·»åŠ æ–°ç§å­</h3>
                <button onclick="closeAddTorrent()" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="space-y-4">
                    <div class="input-group">
                        <label>ğŸ”— ç£åŠ›é“¾æ¥æˆ–ç§å­URL</label>
                        <input type="text" id="torrentUrl" placeholder="magnet:?xt=urn:btih:..." class="input-field">
                    </div>
                    
                    <div class="input-group">
                        <label>ğŸ“ ä¿å­˜è·¯å¾„ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" id="savePath" placeholder="/downloads/movies" class="input-field">
                    </div>
                    
                    <div class="input-group">
                        <label>ğŸ·ï¸ åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</label>
                        <select id="category" class="input-field">
                            <option value="">é»˜è®¤</option>
                            <option value="movies">ç”µå½±</option>
                            <option value="series">å‰§é›†</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    
                    <div class="flex gap-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="autoStart" checked class="rounded">
                            <span class="text-sm">ğŸš€ è‡ªåŠ¨å¼€å§‹ä¸‹è½½</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="sequentialDownload" class="rounded">
                            <span class="text-sm">ğŸ“ é¡ºåºä¸‹è½½</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeAddTorrent()" class="btn btn-secondary">
                    å–æ¶ˆ
                </button>
                <button onclick="addTorrent()" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    æ·»åŠ ç§å­
                </button>
            </div>
        </div>
    </div>
    
    <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
    <button id="backToTop" onclick="scrollToTop()" class="fixed bottom-8 right-8 btn btn-primary rounded-full w-12 h-12 hidden">
        <i class="fas fa-arrow-up"></i>
    </button>
    
    <script src="static/js/components.js"></script>
    <script src="static/js/modern-nav.js"></script>
    <script src="static/js/performance.js"></script>
    <script>
        let allDownloads = [];
        let currentFilter = 'all';
        let refreshInterval;
        
        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            loadDownloads();
            
            // è‡ªåŠ¨åˆ·æ–°
            const autoRefreshCheckbox = document.getElementById('autoRefresh');
            if (autoRefreshCheckbox.checked) {
                refreshInterval = setInterval(loadDownloads, 5000); // æ¯5ç§’åˆ·æ–°
            }
            
            autoRefreshCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    refreshInterval = setInterval(loadDownloads, 5000);
                } else {
                    clearInterval(refreshInterval);
                }
            });
            
            // ç›‘å¬æ»šåŠ¨äº‹ä»¶
            window.addEventListener('scroll', () => {
                const backToTop = document.getElementById('backToTop');
                if (window.scrollY > 300) {
                    backToTop.classList.remove('hidden');
                } else {
                    backToTop.classList.add('hidden');
                }
            });
        });
        
        // åŠ è½½ä¸‹è½½åˆ—è¡¨
        async function loadDownloads() {
            try {
                const [listResponse, statsResponse] = await Promise.all([
                    fetch('/api/v1/torrents/list'),
                    fetch('/api/v1/torrents/status')
                ]);
                
                if (listResponse.ok && statsResponse.ok) {
                    const listData = await listResponse.json();
                    const statsData = await statsResponse.json();
                    
                    if (listData.code === 'SUCCESS') {
                        allDownloads = listData.data.torrents || [];
                        updateStats(statsData.data);
                        renderDownloads();
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ä¸‹è½½åˆ—è¡¨å¤±è´¥:', error);
                // å¦‚æœå¤±è´¥ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                if (!allDownloads.length) {
                    showEmptyState();
                }
            }
        }
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats(stats) {
            // é¦–å…ˆè¿‡æ»¤åªæ˜¾ç¤ºPornDBæ ‡ç­¾çš„ç§å­
            const porndbDownloads = allDownloads.filter(torrent => {
                const tags = torrent.tags || '';
                return tags.includes('PornDB');
            });
            
            // ç»Ÿè®¡å„çŠ¶æ€æ•°é‡
            let downloading = 0;
            let completed = 0;
            let seeding = 0;
            let totalSize = 0;
            let totalDownloadSpeed = 0;
            let totalUploadSpeed = 0;
            let totalRatio = 0;
            let activeCount = 0;
            
            porndbDownloads.forEach(torrent => {
                const state = torrent.state;
                totalSize += torrent.size || 0;
                
                if (state === 'downloading' || state === 'stalledDL' || state === 'metaDL' || state === 'queuedDL') {
                    downloading++;
                    totalDownloadSpeed += torrent.dlspeed || 0;
                    activeCount++;
                } else if (state === 'uploading' || state === 'stalledUP' || state === 'queuedUP') {
                    if (torrent.progress >= 1) {
                        completed++;
                        seeding++;
                    }
                    totalUploadSpeed += torrent.upspeed || 0;
                    if (torrent.dlspeed > 0 || torrent.upspeed > 0) {
                        activeCount++;
                    }
                }
                
                if (torrent.ratio) {
                    totalRatio += torrent.ratio;
                }
            });
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('stat-downloading').textContent = downloading;
            document.getElementById('stat-completed').textContent = completed;
            document.getElementById('stat-seeding').textContent = seeding;
            document.getElementById('stat-size').textContent = formatFileSize(totalSize);
            
            document.getElementById('global-download-speed').textContent = formatSpeed(totalDownloadSpeed);
            document.getElementById('global-upload-speed').textContent = formatSpeed(totalUploadSpeed);
            document.getElementById('active-torrents').textContent = activeCount;
            document.getElementById('total-ratio').textContent = porndbDownloads.length > 0 ? 
                (totalRatio / porndbDownloads.length).toFixed(2) : '0.00';
        }
        
        // æ¸²æŸ“ä¸‹è½½åˆ—è¡¨
        function renderDownloads() {
            const container = document.getElementById('downloadsContainer');
            
            // é¦–å…ˆè¿‡æ»¤åªæ˜¾ç¤ºPornDBæ ‡ç­¾çš„ç§å­
            let porndbDownloads = allDownloads.filter(torrent => {
                // æ£€æŸ¥ç§å­æ˜¯å¦æœ‰PornDBæ ‡ç­¾
                const tags = torrent.tags || '';
                return tags.includes('PornDB');
            });
            
            // åº”ç”¨çŠ¶æ€ç­›é€‰
            let filteredDownloads = filterDownloadsByStatus(porndbDownloads, currentFilter);
            
            if (filteredDownloads.length === 0) {
                if (currentFilter !== 'all') {
                    container.innerHTML = components.createEmptyState(
                        'ğŸ” æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ä¸‹è½½',
                        'fa-filter',
                        {
                            label: 'æŸ¥çœ‹å…¨éƒ¨',
                            icon: 'fas fa-list',
                            onClick: 'document.getElementById("statusFilter").value="all"; filterDownloads()'
                        }
                    );
                } else {
                    showEmptyState();
                }
                return;
            }
            
            // æŒ‰çŠ¶æ€æ’åºï¼šä¸‹è½½ä¸­ > åšç§ä¸­ > æš‚åœ > é”™è¯¯
            filteredDownloads.sort((a, b) => {
                const priority = {
                    'downloading': 0,
                    'stalledDL': 1,
                    'metaDL': 2,
                    'queuedDL': 3,
                    'uploading': 4,
                    'stalledUP': 5,
                    'queuedUP': 6,
                    'pausedDL': 7,
                    'pausedUP': 8,
                    'error': 9
                };
                return (priority[a.state] || 10) - (priority[b.state] || 10);
            });
            
            container.innerHTML = `
                <div class="space-y-4">
                    ${filteredDownloads.map(torrent => createDownloadCard(torrent)).join('')}
                </div>
            `;
        }
        
        // ç­›é€‰ä¸‹è½½
        function filterDownloadsByStatus(downloads, status) {
            if (status === 'all') return downloads;
            
            return downloads.filter(torrent => {
                const state = torrent.state;
                switch (status) {
                    case 'downloading':
                        return state === 'downloading' || state === 'stalledDL' || 
                               state === 'metaDL' || state === 'queuedDL' || state === 'allocating';
                    case 'completed':
                        return torrent.progress >= 1;
                    case 'seeding':
                        return state === 'uploading' || state === 'stalledUP' || state === 'queuedUP';
                    case 'paused':
                        return state === 'pausedDL' || state === 'pausedUP';
                    case 'error':
                        return state === 'error' || state === 'missingFiles';
                    default:
                        return true;
                }
            });
        }
        
        // åˆ›å»ºä¸‹è½½å¡ç‰‡
        function createDownloadCard(torrent) {
            const progress = (torrent.progress || 0) * 100;
            const status = getStatusInfo(torrent.state);
            const size = formatFileSize(torrent.size || 0);
            const downloaded = formatFileSize((torrent.size || 0) * (torrent.progress || 0));
            const dlSpeed = formatSpeed(torrent.dlspeed || 0);
            const upSpeed = formatSpeed(torrent.upspeed || 0);
            const eta = torrent.eta && torrent.eta !== 8640000 ? formatTime(torrent.eta) : '';
            const ratio = (torrent.ratio || 0).toFixed(2);
            
            return `
                <div class="glass-card hover-scale p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-semibold mb-2 truncate" title="${torrent.name}">
                                ğŸ“¦ ${torrent.name}
                            </h3>
                            <div class="flex flex-wrap gap-4 text-sm text-muted">
                                <span><i class="fas fa-hdd"></i> ${size}</span>
                                <span><i class="fas fa-download"></i> ${downloaded}</span>
                                ${eta ? `<span><i class="fas fa-clock"></i> ${eta}</span>` : ''}
                                <span><i class="fas fa-share"></i> åˆ†äº«ç‡: ${ratio}</span>
                            </div>
                        </div>
                        <span class="status-badge ${status.class}">${status.icon} ${status.text}</span>
                    </div>
                    
                    <!-- è¿›åº¦æ¡ -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-muted">è¿›åº¦</span>
                            <span class="font-medium">${progress.toFixed(1)}%</span>
                        </div>
                        <div class="w-full bg-gray-700/50 rounded-full h-2 overflow-hidden">
                            <div class="progress-bar h-full rounded-full" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    
                    <!-- é€Ÿåº¦å’Œç§å­ä¿¡æ¯ -->
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-4 text-muted">
                            <span class="speed-indicator">
                                <i class="fas fa-arrow-down speed-arrow-down"></i>
                                ${dlSpeed}
                            </span>
                            <span class="speed-indicator">
                                <i class="fas fa-arrow-up speed-arrow-up"></i>
                                ${upSpeed}
                            </span>
                            <span><i class="fas fa-users"></i> ${torrent.num_seeds || 0}/${torrent.num_leechs || 0}</span>
                        </div>
                        <div class="flex gap-2">
                            ${torrent.state === 'pausedDL' || torrent.state === 'pausedUP' ? `
                                <button onclick="resumeTorrent('${torrent.hash}')" class="btn btn-sm btn-success">
                                    <i class="fas fa-play"></i>
                                </button>
                            ` : `
                                <button onclick="pauseTorrent('${torrent.hash}')" class="btn btn-sm btn-warning">
                                    <i class="fas fa-pause"></i>
                                </button>
                            `}
                            <button onclick="showTorrentDetails('${torrent.hash}')" class="btn btn-sm btn-secondary">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            <button onclick="confirmDelete('${torrent.hash}')" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // è·å–çŠ¶æ€ä¿¡æ¯
        function getStatusInfo(state) {
            const statusMap = {
                'downloading': { text: 'ä¸‹è½½ä¸­', icon: 'â¬‡ï¸', class: 'status-downloading' },
                'stalledDL': { text: 'ç­‰å¾…ä¸­', icon: 'â³', class: 'status-downloading' },
                'metaDL': { text: 'è·å–ä¿¡æ¯', icon: 'ğŸ”', class: 'status-downloading' },
                'allocating': { text: 'åˆ†é…ç©ºé—´', icon: 'ğŸ’¾', class: 'status-downloading' },
                'queuedDL': { text: 'æ’é˜Ÿä¸‹è½½', icon: 'ğŸ“', class: 'status-queued' },
                'uploading': { text: 'åšç§ä¸­', icon: 'ğŸŒ±', class: 'status-seeding' },
                'stalledUP': { text: 'åšç§ç­‰å¾…', icon: 'ğŸŒ¿', class: 'status-seeding' },
                'queuedUP': { text: 'æ’é˜Ÿä¸Šä¼ ', icon: 'ğŸ“¤', class: 'status-seeding' },
                'pausedDL': { text: 'å·²æš‚åœ', icon: 'â¸ï¸', class: 'status-paused' },
                'pausedUP': { text: 'æš‚åœåšç§', icon: 'â¸ï¸', class: 'status-paused' },
                'error': { text: 'é”™è¯¯', icon: 'âŒ', class: 'status-error' },
                'missingFiles': { text: 'æ–‡ä»¶ä¸¢å¤±', icon: 'âš ï¸', class: 'status-error' }
            };
            
            return statusMap[state] || { text: state, icon: 'â“', class: 'status-paused' };
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // æ ¼å¼åŒ–é€Ÿåº¦
        function formatSpeed(bytesPerSecond) {
            if (!bytesPerSecond || bytesPerSecond === 0) return '0 B/s';
            return formatFileSize(bytesPerSecond) + '/s';
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
            if (seconds < 60) return `${seconds}ç§’`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}åˆ†é’Ÿ`;
            if (seconds < 86400) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${hours}å°æ—¶${minutes > 0 ? minutes + 'åˆ†é’Ÿ' : ''}`;
            }
            return `${Math.floor(seconds / 86400)}å¤©`;
        }
        
        // æ˜¾ç¤ºç©ºçŠ¶æ€
        function showEmptyState() {
            const container = document.getElementById('downloadsContainer');
            container.innerHTML = components.createEmptyState(
                'ğŸ“­ æš‚æ— ä¸‹è½½ä»»åŠ¡',
                'fa-download',
                {
                    label: 'å»æœç´¢å½±ç‰‡',
                    icon: 'fas fa-search',
                    onClick: 'window.location.href="/search.html"'
                }
            );
        }
        
        // ç­›é€‰ä¸‹è½½
        function filterDownloads() {
            currentFilter = document.getElementById('statusFilter').value;
            renderDownloads();
        }
        
        // åˆ·æ–°ä¸‹è½½åˆ—è¡¨
        function refreshDownloads() {
            components.showNotification('ğŸ”„ æ­£åœ¨åˆ·æ–°...', 'info');
            loadDownloads();
        }
        
        // æ˜¾ç¤ºæ·»åŠ ç§å­å¯¹è¯æ¡†
        function showAddTorrent() {
            document.getElementById('addTorrentModal').classList.remove('hidden');
        }
        
        // å…³é—­æ·»åŠ ç§å­å¯¹è¯æ¡†
        function closeAddTorrent() {
            document.getElementById('addTorrentModal').classList.add('hidden');
            document.getElementById('torrentUrl').value = '';
            document.getElementById('savePath').value = '';
        }
        
        // æ·»åŠ ç§å­
        async function addTorrent() {
            const url = document.getElementById('torrentUrl').value.trim();
            if (!url) {
                components.showNotification('ğŸ˜… è¯·è¾“å…¥ç§å­é“¾æ¥', 'warning');
                return;
            }
            
            const data = {
                urls: url,
                savepath: document.getElementById('savePath').value,
                category: document.getElementById('category').value,
                paused: !document.getElementById('autoStart').checked,
                sequentialDownload: document.getElementById('sequentialDownload').checked
            };
            
            try {
                const response = await fetch('/api/v1/torrents/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    components.showNotification('âœ… ç§å­æ·»åŠ æˆåŠŸ', 'success');
                    closeAddTorrent();
                    setTimeout(loadDownloads, 1000);
                } else {
                    components.showNotification('ğŸ˜… æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            } catch (error) {
                components.showNotification('ğŸ˜… ç½‘ç»œé”™è¯¯', 'error');
            }
        }
        
        // æš‚åœç§å­
        async function pauseTorrent(hash) {
            try {
                const response = await fetch(`/api/v1/torrents/pause/${hash}`, { method: 'POST' });
                if (response.ok) {
                    components.showNotification('â¸ï¸ å·²æš‚åœ', 'success');
                    loadDownloads();
                }
            } catch (error) {
                components.showNotification('ğŸ˜… æ“ä½œå¤±è´¥', 'error');
            }
        }
        
        // ç»§ç»­ç§å­
        async function resumeTorrent(hash) {
            try {
                const response = await fetch(`/api/v1/torrents/resume/${hash}`, { method: 'POST' });
                if (response.ok) {
                    components.showNotification('â–¶ï¸ å·²ç»§ç»­', 'success');
                    loadDownloads();
                }
            } catch (error) {
                components.showNotification('ğŸ˜… æ“ä½œå¤±è´¥', 'error');
            }
        }
        
        // ç¡®è®¤åˆ é™¤
        function confirmDelete(hash) {
            if (confirm('ğŸ—‘ï¸ ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¸‹è½½ä»»åŠ¡å—ï¼Ÿ')) {
                deleteTorrent(hash);
            }
        }
        
        // åˆ é™¤ç§å­
        async function deleteTorrent(hash) {
            try {
                const response = await fetch(`/api/v1/torrents/delete/${hash}`, { method: 'DELETE' });
                if (response.ok) {
                    components.showNotification('ğŸ—‘ï¸ å·²åˆ é™¤', 'success');
                    loadDownloads();
                }
            } catch (error) {
                components.showNotification('ğŸ˜… åˆ é™¤å¤±è´¥', 'error');
            }
        }
        
        // æš‚åœå…¨éƒ¨
        async function pauseAll() {
            try {
                const response = await fetch('/api/v1/torrents/pause', { method: 'POST' });
                if (response.ok) {
                    components.showNotification('â¸ï¸ å·²å…¨éƒ¨æš‚åœ', 'success');
                    loadDownloads();
                }
            } catch (error) {
                components.showNotification('ğŸ˜… æ“ä½œå¤±è´¥', 'error');
            }
        }
        
        // ç»§ç»­å…¨éƒ¨
        async function resumeAll() {
            try {
                const response = await fetch('/api/v1/torrents/resume', { method: 'POST' });
                if (response.ok) {
                    components.showNotification('â–¶ï¸ å·²å…¨éƒ¨ç»§ç»­', 'success');
                    loadDownloads();
                }
            } catch (error) {
                components.showNotification('ğŸ˜… æ“ä½œå¤±è´¥', 'error');
            }
        }
        
        // æ˜¾ç¤ºç§å­è¯¦æƒ…
        function showTorrentDetails(hash) {
            const torrent = allDownloads.find(t => t.hash === hash);
            if (!torrent) return;
            
            // TODO: å®ç°è¯¦æƒ…æ¨¡æ€æ¡†
            console.log('ç§å­è¯¦æƒ…:', torrent);
            components.showNotification('ğŸ“‹ è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }
        
        // è¿”å›é¡¶éƒ¨
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
    
    <!-- å¼•å…¥å¤–éƒ¨downloads.js -->
    <script src="static/js/downloads.js"></script>
</body>
</html>