<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📥 下载管理 - NSFW-Go</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="static/css/design-system.css">
    <link rel="stylesheet" href="static/css/components.css">
    <link rel="stylesheet" href="static/css/tailwind-fixes.css">
    <style>
        /* 页面特定样式 */
        .downloads-container {
            min-height: calc(100vh - 64px);
            padding: 2rem 1rem;
        }
        
        .progress-bar {
            transition: width 0.3s ease;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
        }
        
        .download-card {
            transition: all 0.3s ease;
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
        }
        
        .status-downloading {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }
        
        .status-completed {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }
        
        .status-seeding {
            background: rgba(168, 85, 247, 0.2);
            color: #c4b5fd;
        }
        
        .status-paused {
            background: rgba(251, 191, 36, 0.2);
            color: #fcd34d;
        }
        
        .status-queued {
            background: rgba(156, 163, 175, 0.2);
            color: #d1d5db;
        }
        
        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }
        
        /* 速度指示器 */
        .speed-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .speed-arrow-up {
            color: var(--success);
        }
        
        .speed-arrow-down {
            color: var(--primary);
        }
        
        /* 文件列表 */
        .file-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .file-item {
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background 0.2s;
        }
        
        .file-item:hover {
            background: var(--bg-dark-tertiary);
        }
    </style>
</head>
<body>
    <!-- 导航栏将由modern-nav.js自动插入 -->
    
    <!-- 主内容区 -->
    <main class="page-container downloads-container">
        <!-- 页面头部 -->
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold mb-4">
                <span class="glow-text">📥 下载管理</span>
            </h1>
            <p class="text-sm text-muted">管理您的种子下载任务，实时查看下载进度 🚀</p>
        </div>
        
        <!-- 操作栏 -->
        <div class="glass-card p-6 mb-6">
            <div class="flex flex-wrap gap-4 items-center justify-between">
                <div class="flex gap-3">
                    <button onclick="refreshDownloads()" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i>
                        <span>刷新列表</span>
                    </button>
                    <button onclick="showAddTorrent()" class="btn btn-secondary">
                        <i class="fas fa-plus"></i>
                        <span>添加种子</span>
                    </button>
                    <button onclick="pauseAll()" class="btn btn-warning">
                        <i class="fas fa-pause"></i>
                        <span>全部暂停</span>
                    </button>
                    <button onclick="resumeAll()" class="btn btn-success">
                        <i class="fas fa-play"></i>
                        <span>全部继续</span>
                    </button>
                </div>
                
                <!-- 筛选选项 -->
                <div class="flex gap-2">
                    <select id="statusFilter" onchange="filterDownloads()" class="input-field w-40">
                        <option value="all">🔍 全部状态</option>
                        <option value="downloading">⬇️ 下载中</option>
                        <option value="completed">✅ 已完成</option>
                        <option value="seeding">🌱 做种中</option>
                        <option value="paused">⏸️ 已暂停</option>
                        <option value="error">❌ 有错误</option>
                    </select>
                    
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="autoRefresh" checked class="rounded">
                        <span class="text-sm">🔄 自动刷新</span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- 统计概览 -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="stat-card">
                <div class="stat-icon bg-blue-500/20">
                    <i class="fas fa-download text-blue-400"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="stat-downloading">0</div>
                    <div class="stat-label">⬇️ 下载中</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon bg-green-500/20">
                    <i class="fas fa-check text-green-400"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="stat-completed">0</div>
                    <div class="stat-label">✅ 已完成</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon bg-purple-500/20">
                    <i class="fas fa-seedling text-purple-400"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="stat-seeding">0</div>
                    <div class="stat-label">🌱 做种中</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon bg-yellow-500/20">
                    <i class="fas fa-hdd text-yellow-400"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="stat-size">0 GB</div>
                    <div class="stat-label">💾 总大小</div>
                </div>
            </div>
        </div>
        
        <!-- 全局速度信息 -->
        <div class="glass-card p-4 mb-6">
            <div class="flex justify-around items-center">
                <div class="text-center">
                    <div class="speed-indicator text-lg font-bold">
                        <i class="fas fa-arrow-down speed-arrow-down"></i>
                        <span id="global-download-speed">0 MB/s</span>
                    </div>
                    <p class="text-sm text-muted mt-1">下载速度</p>
                </div>
                <div class="text-center">
                    <div class="speed-indicator text-lg font-bold">
                        <i class="fas fa-arrow-up speed-arrow-up"></i>
                        <span id="global-upload-speed">0 MB/s</span>
                    </div>
                    <p class="text-sm text-muted mt-1">上传速度</p>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold">
                        <span id="active-torrents">0</span>
                    </div>
                    <p class="text-sm text-muted mt-1">活动任务</p>
                </div>
                <div class="text-center">
                    <div class="text-lg font-bold">
                        <span id="total-ratio">0.00</span>
                    </div>
                    <p class="text-sm text-muted mt-1">分享率</p>
                </div>
            </div>
        </div>
        
        <!-- 下载列表 -->
        <div id="downloadsContainer">
            <!-- 初始加载状态 -->
            <div class="empty-state flex-center" style="min-height: 400px;">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin empty-icon text-6xl mb-4"></i>
                    <p class="text-lg text-muted">🔄 正在加载下载列表...</p>
                </div>
            </div>
        </div>
    </main>
    
    <!-- 添加种子模态框 -->
    <div id="addTorrentModal" class="modal hidden">
        <div class="modal-content max-w-2xl">
            <div class="modal-header">
                <h3 class="text-lg font-semibold">➕ 添加新种子</h3>
                <button onclick="closeAddTorrent()" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="space-y-4">
                    <div class="input-group">
                        <label>🔗 磁力链接或种子URL</label>
                        <input type="text" id="torrentUrl" placeholder="magnet:?xt=urn:btih:..." class="input-field">
                    </div>
                    
                    <div class="input-group">
                        <label>📁 保存路径（可选）</label>
                        <input type="text" id="savePath" placeholder="/downloads/movies" class="input-field">
                    </div>
                    
                    <div class="input-group">
                        <label>🏷️ 分类（可选）</label>
                        <select id="category" class="input-field">
                            <option value="">默认</option>
                            <option value="movies">电影</option>
                            <option value="series">剧集</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    
                    <div class="flex gap-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="autoStart" checked class="rounded">
                            <span class="text-sm">🚀 自动开始下载</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="sequentialDownload" class="rounded">
                            <span class="text-sm">📝 顺序下载</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeAddTorrent()" class="btn btn-secondary">
                    取消
                </button>
                <button onclick="addTorrent()" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    添加种子
                </button>
            </div>
        </div>
    </div>
    
    <!-- 返回顶部按钮 -->
    <button id="backToTop" onclick="scrollToTop()" class="fixed bottom-8 right-8 btn btn-primary rounded-full w-12 h-12 hidden">
        <i class="fas fa-arrow-up"></i>
    </button>
    
    <script src="static/js/components.js"></script>
    <script src="static/js/modern-nav.js"></script>
    <script src="static/js/performance.js"></script>
    <script>
        let allDownloads = [];
        let currentFilter = 'all';
        let refreshInterval;
        
        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            loadDownloads();
            
            // 自动刷新
            const autoRefreshCheckbox = document.getElementById('autoRefresh');
            if (autoRefreshCheckbox.checked) {
                refreshInterval = setInterval(loadDownloads, 5000); // 每5秒刷新
            }
            
            autoRefreshCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    refreshInterval = setInterval(loadDownloads, 5000);
                } else {
                    clearInterval(refreshInterval);
                }
            });
            
            // 监听滚动事件
            window.addEventListener('scroll', () => {
                const backToTop = document.getElementById('backToTop');
                if (window.scrollY > 300) {
                    backToTop.classList.remove('hidden');
                } else {
                    backToTop.classList.add('hidden');
                }
            });
        });
        
        // 加载下载列表
        async function loadDownloads() {
            try {
                const [listResponse, statsResponse] = await Promise.all([
                    fetch('/api/v1/torrents/list'),
                    fetch('/api/v1/torrents/status')
                ]);
                
                if (listResponse.ok && statsResponse.ok) {
                    const listData = await listResponse.json();
                    const statsData = await statsResponse.json();
                    
                    if (listData.code === 'SUCCESS') {
                        allDownloads = listData.data.torrents || [];
                        updateStats(statsData.data);
                        renderDownloads();
                    }
                }
            } catch (error) {
                console.error('加载下载列表失败:', error);
                // 如果失败，显示空状态
                if (!allDownloads.length) {
                    showEmptyState();
                }
            }
        }
        
        // 更新统计数据
        function updateStats(stats) {
            // 首先过滤只显示PornDB标签的种子
            const porndbDownloads = allDownloads.filter(torrent => {
                const tags = torrent.tags || '';
                return tags.includes('PornDB');
            });
            
            // 统计各状态数量
            let downloading = 0;
            let completed = 0;
            let seeding = 0;
            let totalSize = 0;
            let totalDownloadSpeed = 0;
            let totalUploadSpeed = 0;
            let totalRatio = 0;
            let activeCount = 0;
            
            porndbDownloads.forEach(torrent => {
                const state = torrent.state;
                totalSize += torrent.size || 0;
                
                if (state === 'downloading' || state === 'stalledDL' || state === 'metaDL' || state === 'queuedDL') {
                    downloading++;
                    totalDownloadSpeed += torrent.dlspeed || 0;
                    activeCount++;
                } else if (state === 'uploading' || state === 'stalledUP' || state === 'queuedUP') {
                    if (torrent.progress >= 1) {
                        completed++;
                        seeding++;
                    }
                    totalUploadSpeed += torrent.upspeed || 0;
                    if (torrent.dlspeed > 0 || torrent.upspeed > 0) {
                        activeCount++;
                    }
                }
                
                if (torrent.ratio) {
                    totalRatio += torrent.ratio;
                }
            });
            
            // 更新显示
            document.getElementById('stat-downloading').textContent = downloading;
            document.getElementById('stat-completed').textContent = completed;
            document.getElementById('stat-seeding').textContent = seeding;
            document.getElementById('stat-size').textContent = formatFileSize(totalSize);
            
            document.getElementById('global-download-speed').textContent = formatSpeed(totalDownloadSpeed);
            document.getElementById('global-upload-speed').textContent = formatSpeed(totalUploadSpeed);
            document.getElementById('active-torrents').textContent = activeCount;
            document.getElementById('total-ratio').textContent = porndbDownloads.length > 0 ? 
                (totalRatio / porndbDownloads.length).toFixed(2) : '0.00';
        }
        
        // 渲染下载列表
        function renderDownloads() {
            const container = document.getElementById('downloadsContainer');
            
            // 首先过滤只显示PornDB标签的种子
            let porndbDownloads = allDownloads.filter(torrent => {
                // 检查种子是否有PornDB标签
                const tags = torrent.tags || '';
                return tags.includes('PornDB');
            });
            
            // 应用状态筛选
            let filteredDownloads = filterDownloadsByStatus(porndbDownloads, currentFilter);
            
            if (filteredDownloads.length === 0) {
                if (currentFilter !== 'all') {
                    container.innerHTML = components.createEmptyState(
                        '🔍 没有找到符合条件的下载',
                        'fa-filter',
                        {
                            label: '查看全部',
                            icon: 'fas fa-list',
                            onClick: 'document.getElementById("statusFilter").value="all"; filterDownloads()'
                        }
                    );
                } else {
                    showEmptyState();
                }
                return;
            }
            
            // 按状态排序：下载中 > 做种中 > 暂停 > 错误
            filteredDownloads.sort((a, b) => {
                const priority = {
                    'downloading': 0,
                    'stalledDL': 1,
                    'metaDL': 2,
                    'queuedDL': 3,
                    'uploading': 4,
                    'stalledUP': 5,
                    'queuedUP': 6,
                    'pausedDL': 7,
                    'pausedUP': 8,
                    'error': 9
                };
                return (priority[a.state] || 10) - (priority[b.state] || 10);
            });
            
            container.innerHTML = `
                <div class="space-y-4">
                    ${filteredDownloads.map(torrent => createDownloadCard(torrent)).join('')}
                </div>
            `;
        }
        
        // 筛选下载
        function filterDownloadsByStatus(downloads, status) {
            if (status === 'all') return downloads;
            
            return downloads.filter(torrent => {
                const state = torrent.state;
                switch (status) {
                    case 'downloading':
                        return state === 'downloading' || state === 'stalledDL' || 
                               state === 'metaDL' || state === 'queuedDL' || state === 'allocating';
                    case 'completed':
                        return torrent.progress >= 1;
                    case 'seeding':
                        return state === 'uploading' || state === 'stalledUP' || state === 'queuedUP';
                    case 'paused':
                        return state === 'pausedDL' || state === 'pausedUP';
                    case 'error':
                        return state === 'error' || state === 'missingFiles';
                    default:
                        return true;
                }
            });
        }
        
        // 创建下载卡片
        function createDownloadCard(torrent) {
            const progress = (torrent.progress || 0) * 100;
            const status = getStatusInfo(torrent.state);
            const size = formatFileSize(torrent.size || 0);
            const downloaded = formatFileSize((torrent.size || 0) * (torrent.progress || 0));
            const dlSpeed = formatSpeed(torrent.dlspeed || 0);
            const upSpeed = formatSpeed(torrent.upspeed || 0);
            const eta = torrent.eta && torrent.eta !== 8640000 ? formatTime(torrent.eta) : '';
            const ratio = (torrent.ratio || 0).toFixed(2);
            
            return `
                <div class="glass-card hover-scale p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-semibold mb-2 truncate" title="${torrent.name}">
                                📦 ${torrent.name}
                            </h3>
                            <div class="flex flex-wrap gap-4 text-sm text-muted">
                                <span><i class="fas fa-hdd"></i> ${size}</span>
                                <span><i class="fas fa-download"></i> ${downloaded}</span>
                                ${eta ? `<span><i class="fas fa-clock"></i> ${eta}</span>` : ''}
                                <span><i class="fas fa-share"></i> 分享率: ${ratio}</span>
                            </div>
                        </div>
                        <span class="status-badge ${status.class}">${status.icon} ${status.text}</span>
                    </div>
                    
                    <!-- 进度条 -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-muted">进度</span>
                            <span class="font-medium">${progress.toFixed(1)}%</span>
                        </div>
                        <div class="w-full bg-gray-700/50 rounded-full h-2 overflow-hidden">
                            <div class="progress-bar h-full rounded-full" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    
                    <!-- 速度和种子信息 -->
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-4 text-muted">
                            <span class="speed-indicator">
                                <i class="fas fa-arrow-down speed-arrow-down"></i>
                                ${dlSpeed}
                            </span>
                            <span class="speed-indicator">
                                <i class="fas fa-arrow-up speed-arrow-up"></i>
                                ${upSpeed}
                            </span>
                            <span><i class="fas fa-users"></i> ${torrent.num_seeds || 0}/${torrent.num_leechs || 0}</span>
                        </div>
                        <div class="flex gap-2">
                            ${torrent.state === 'pausedDL' || torrent.state === 'pausedUP' ? `
                                <button onclick="resumeTorrent('${torrent.hash}')" class="btn btn-sm btn-success">
                                    <i class="fas fa-play"></i>
                                </button>
                            ` : `
                                <button onclick="pauseTorrent('${torrent.hash}')" class="btn btn-sm btn-warning">
                                    <i class="fas fa-pause"></i>
                                </button>
                            `}
                            <button onclick="showTorrentDetails('${torrent.hash}')" class="btn btn-sm btn-secondary">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            <button onclick="confirmDelete('${torrent.hash}')" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 获取状态信息
        function getStatusInfo(state) {
            const statusMap = {
                'downloading': { text: '下载中', icon: '⬇️', class: 'status-downloading' },
                'stalledDL': { text: '等待中', icon: '⏳', class: 'status-downloading' },
                'metaDL': { text: '获取信息', icon: '🔍', class: 'status-downloading' },
                'allocating': { text: '分配空间', icon: '💾', class: 'status-downloading' },
                'queuedDL': { text: '排队下载', icon: '📝', class: 'status-queued' },
                'uploading': { text: '做种中', icon: '🌱', class: 'status-seeding' },
                'stalledUP': { text: '做种等待', icon: '🌿', class: 'status-seeding' },
                'queuedUP': { text: '排队上传', icon: '📤', class: 'status-seeding' },
                'pausedDL': { text: '已暂停', icon: '⏸️', class: 'status-paused' },
                'pausedUP': { text: '暂停做种', icon: '⏸️', class: 'status-paused' },
                'error': { text: '错误', icon: '❌', class: 'status-error' },
                'missingFiles': { text: '文件丢失', icon: '⚠️', class: 'status-error' }
            };
            
            return statusMap[state] || { text: state, icon: '❓', class: 'status-paused' };
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 格式化速度
        function formatSpeed(bytesPerSecond) {
            if (!bytesPerSecond || bytesPerSecond === 0) return '0 B/s';
            return formatFileSize(bytesPerSecond) + '/s';
        }
        
        // 格式化时间
        function formatTime(seconds) {
            if (seconds < 60) return `${seconds}秒`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}分钟`;
            if (seconds < 86400) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${hours}小时${minutes > 0 ? minutes + '分钟' : ''}`;
            }
            return `${Math.floor(seconds / 86400)}天`;
        }
        
        // 显示空状态
        function showEmptyState() {
            const container = document.getElementById('downloadsContainer');
            container.innerHTML = components.createEmptyState(
                '📭 暂无下载任务',
                'fa-download',
                {
                    label: '去搜索影片',
                    icon: 'fas fa-search',
                    onClick: 'window.location.href="/search.html"'
                }
            );
        }
        
        // 筛选下载
        function filterDownloads() {
            currentFilter = document.getElementById('statusFilter').value;
            renderDownloads();
        }
        
        // 刷新下载列表
        function refreshDownloads() {
            components.showNotification('🔄 正在刷新...', 'info');
            loadDownloads();
        }
        
        // 显示添加种子对话框
        function showAddTorrent() {
            document.getElementById('addTorrentModal').classList.remove('hidden');
        }
        
        // 关闭添加种子对话框
        function closeAddTorrent() {
            document.getElementById('addTorrentModal').classList.add('hidden');
            document.getElementById('torrentUrl').value = '';
            document.getElementById('savePath').value = '';
        }
        
        // 添加种子
        async function addTorrent() {
            const url = document.getElementById('torrentUrl').value.trim();
            if (!url) {
                components.showNotification('😅 请输入种子链接', 'warning');
                return;
            }
            
            const data = {
                urls: url,
                savepath: document.getElementById('savePath').value,
                category: document.getElementById('category').value,
                paused: !document.getElementById('autoStart').checked,
                sequentialDownload: document.getElementById('sequentialDownload').checked
            };
            
            try {
                const response = await fetch('/api/v1/torrents/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    components.showNotification('✅ 种子添加成功', 'success');
                    closeAddTorrent();
                    setTimeout(loadDownloads, 1000);
                } else {
                    components.showNotification('😅 添加失败，请重试', 'error');
                }
            } catch (error) {
                components.showNotification('😅 网络错误', 'error');
            }
        }
        
        // 暂停种子
        async function pauseTorrent(hash) {
            try {
                const response = await fetch(`/api/v1/torrents/pause/${hash}`, { method: 'POST' });
                if (response.ok) {
                    components.showNotification('⏸️ 已暂停', 'success');
                    loadDownloads();
                }
            } catch (error) {
                components.showNotification('😅 操作失败', 'error');
            }
        }
        
        // 继续种子
        async function resumeTorrent(hash) {
            try {
                const response = await fetch(`/api/v1/torrents/resume/${hash}`, { method: 'POST' });
                if (response.ok) {
                    components.showNotification('▶️ 已继续', 'success');
                    loadDownloads();
                }
            } catch (error) {
                components.showNotification('😅 操作失败', 'error');
            }
        }
        
        // 确认删除
        function confirmDelete(hash) {
            if (confirm('🗑️ 确定要删除这个下载任务吗？')) {
                deleteTorrent(hash);
            }
        }
        
        // 删除种子
        async function deleteTorrent(hash) {
            try {
                const response = await fetch(`/api/v1/torrents/delete/${hash}`, { method: 'DELETE' });
                if (response.ok) {
                    components.showNotification('🗑️ 已删除', 'success');
                    loadDownloads();
                }
            } catch (error) {
                components.showNotification('😅 删除失败', 'error');
            }
        }
        
        // 暂停全部
        async function pauseAll() {
            try {
                const response = await fetch('/api/v1/torrents/pause', { method: 'POST' });
                if (response.ok) {
                    components.showNotification('⏸️ 已全部暂停', 'success');
                    loadDownloads();
                }
            } catch (error) {
                components.showNotification('😅 操作失败', 'error');
            }
        }
        
        // 继续全部
        async function resumeAll() {
            try {
                const response = await fetch('/api/v1/torrents/resume', { method: 'POST' });
                if (response.ok) {
                    components.showNotification('▶️ 已全部继续', 'success');
                    loadDownloads();
                }
            } catch (error) {
                components.showNotification('😅 操作失败', 'error');
            }
        }
        
        // 显示种子详情
        function showTorrentDetails(hash) {
            const torrent = allDownloads.find(t => t.hash === hash);
            if (!torrent) return;
            
            // TODO: 实现详情模态框
            console.log('种子详情:', torrent);
            components.showNotification('📋 详情功能开发中...', 'info');
        }
        
        // 返回顶部
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // 页面卸载时清理
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
    
    <!-- 引入外部downloads.js -->
    <script src="static/js/downloads.js"></script>
</body>
</html>