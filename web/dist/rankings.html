<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ† å½±ç‰‡æ’è¡Œæ¦œ - NSFW-Go</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="static/css/design-system.css">
    <link rel="stylesheet" href="static/css/components.css">
    <link rel="stylesheet" href="static/css/tailwind-fixes.css">
    <style>
        /* é¡µé¢ç‰¹å®šæ ·å¼ */
        .rankings-container {
            min-height: calc(100vh - 64px);
            padding: 2rem 1rem;
        }
        
        .rank-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.5rem;
        }
        
        @media (max-width: 640px) {
            .rank-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .rank-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
        
        .rank-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 20;
        }
        
        .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); }
        .rank-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
        .rank-3 { background: linear-gradient(135deg, #CD7F32, #B87333); }
        .rank-other { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); }
        
        .rank-type-tab {
            transition: all 0.3s;
        }
        
        .rank-type-tab.active {
            background: var(--primary-gradient);
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ å°†ç”±modern-nav.jsè‡ªåŠ¨æ’å…¥ -->
    
    <!-- ä¸»å†…å®¹åŒº -->
    <main class="page-container rankings-container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold mb-4">
                <span class="glow-text">ğŸ† å½±ç‰‡æ’è¡Œæ¦œ</span>
            </h1>
            <p class="text-sm text-muted">JAVDb çƒ­é—¨å½±ç‰‡æ’è¡Œï¼Œæ¯æ—¥æ›´æ–°æœ€å—æ¬¢è¿çš„ä½œå“ ğŸ”¥</p>
        </div>
        
        <!-- æ’è¡Œæ¦œç±»å‹åˆ‡æ¢ -->
        <div class="glass-card p-6 mb-8">
            <div class="flex flex-wrap gap-3 justify-center">
                <button onclick="switchRankType('daily')" class="btn btn-primary rank-type-tab active" id="dailyTab">
                    <i class="fas fa-calendar-day"></i>
                    <span>ğŸ“… æ—¥æ¦œ</span>
                </button>
                <button onclick="switchRankType('weekly')" class="btn btn-secondary rank-type-tab" id="weeklyTab">
                    <i class="fas fa-calendar-week"></i>
                    <span>ğŸ“† å‘¨æ¦œ</span>
                </button>
                <button onclick="switchRankType('monthly')" class="btn btn-secondary rank-type-tab" id="monthlyTab">
                    <i class="fas fa-calendar-alt"></i>
                    <span>ğŸ“Š æœˆæ¦œ</span>
                </button>
                <button onclick="refreshRankings()" class="btn btn-secondary ml-auto">
                    <i class="fas fa-sync-alt"></i>
                    <span>ğŸ”„ åˆ·æ–°</span>
                </button>
            </div>
            
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="mt-4 flex flex-wrap gap-4 justify-center text-sm">
                <div class="badge badge-success">
                    âœ… æœ¬åœ°å·²æœ‰ï¼š<span id="localCount">0</span> éƒ¨
                </div>
                <div class="badge badge-warning">
                    ğŸ“¥ å¯ä¸‹è½½ï¼š<span id="downloadableCount">0</span> éƒ¨
                </div>
                <div class="badge badge-primary">
                    â° æ›´æ–°æ—¶é—´ï¼š<span id="updateTime">--</span>
                </div>
            </div>
        </div>
        
        <!-- ç­›é€‰å’Œæœç´¢ -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
            <div class="flex-1">
                <div class="relative">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="ğŸ” æœç´¢æ’è¡Œæ¦œ..." 
                        class="input-field pl-10"
                        onkeyup="filterRankings()"
                    >
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-muted"></i>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleLocalOnly()" class="btn btn-secondary" id="localOnlyBtn">
                    <i class="fas fa-home"></i>
                    <span>åªçœ‹æœ¬åœ°</span>
                </button>
                <button onclick="batchDownload()" class="btn btn-primary">
                    <i class="fas fa-download"></i>
                    <span>æ‰¹é‡ä¸‹è½½</span>
                </button>
            </div>
        </div>
        
        <!-- æ’è¡Œæ¦œå†…å®¹ -->
        <div id="rankingsContainer">
            <div class="loading-state flex-center" style="min-height: 400px;">
                <div class="loader"></div>
                <span class="loading-message ml-3">åŠ è½½æ’è¡Œæ¦œ...</span>
            </div>
        </div>
    </main>
    
    <!-- å½±ç‰‡è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="movieDetailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ¬ å½±ç‰‡è¯¦æƒ…</h3>
                <button onclick="closeMovieDetail()" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="movieDetailContent">
                <!-- è¯¦æƒ…å†…å®¹å°†åŠ¨æ€æ’å…¥ -->
            </div>
            <div class="modal-footer">
                <button onclick="closeMovieDetail()" class="btn btn-secondary">å…³é—­</button>
                <button onclick="downloadMovie()" class="btn btn-primary" id="downloadBtn">
                    <i class="fas fa-download"></i>
                    ä¸‹è½½
                </button>
            </div>
        </div>
    </div>
    
    <!-- è¿”å›é¡¶éƒ¨ -->
    <button id="backToTop" onclick="scrollToTop()" class="fixed bottom-8 right-8 btn btn-primary rounded-full w-12 h-12 hidden">
        <i class="fas fa-arrow-up"></i>
    </button>
    
    <script src="static/js/components.js"></script>
    <script src="static/js/modern-nav.js"></script>
    <script src="static/js/performance.js"></script>
    <script>
        let currentRankType = 'weekly';
        let allRankings = [];
        let filteredRankings = [];
        let localOnlyMode = false;
        let selectedMovies = new Set();
        let currentMovie = null;
        let downloadTasks = new Map(); // å­˜å‚¨ä¸‹è½½ä»»åŠ¡çŠ¶æ€
        let statusUpdateInterval = null; // çŠ¶æ€æ›´æ–°å®šæ—¶å™¨
        
        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            loadRankings('weekly');
            
            // å¯åŠ¨ä¸‹è½½çŠ¶æ€å®šæ—¶æ›´æ–°
            startStatusUpdates();
            
            // ç›‘å¬æ»šåŠ¨
            window.addEventListener('scroll', () => {
                const backToTop = document.getElementById('backToTop');
                if (window.scrollY > 300) {
                    backToTop.classList.remove('hidden');
                } else {
                    backToTop.classList.add('hidden');
                }
            });
        });
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', () => {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
        });
        
        // åŠ è½½æ’è¡Œæ¦œ
        async function loadRankings(type) {
            const container = document.getElementById('rankingsContainer');
            container.innerHTML = components.createLoadingState('ğŸ† åŠ è½½æ’è¡Œæ¦œä¸­...');
            
            try {
                // ç›´æ¥è·å–æŒ‡å®šç±»å‹çš„æ’è¡Œæ¦œæ•°æ®
                const response = await fetch(`/api/v1/rankings?type=${type}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    allRankings = data.data;
                    // æŒ‰æ’åæ’åº
                    allRankings.sort((a, b) => a.position - b.position);
                    filteredRankings = [...allRankings];
                    renderRankings();
                    updateStats();
                    
                    // æ›´æ–°æ—¶é—´
                    document.getElementById('updateTime').textContent = 
                        new Date().toLocaleTimeString('zh-CN');
                } else {
                    throw new Error('åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½æ’è¡Œæ¦œå¤±è´¥:', error);
                container.innerHTML = components.createEmptyState(
                    'ğŸ˜… åŠ è½½æ’è¡Œæ¦œå¤±è´¥',
                    'fa-trophy',
                    {
                        label: 'é‡è¯•',
                        icon: 'fas fa-sync',
                        onClick: `loadRankings('${type}')`
                    }
                );
            }
        }
        
        // æ¸²æŸ“æ’è¡Œæ¦œ
        function renderRankings() {
            const container = document.getElementById('rankingsContainer');
            
            if (filteredRankings.length === 0) {
                container.innerHTML = components.createEmptyState(
                    localOnlyMode ? 'ğŸ˜” æœ¬åœ°æš‚æ— æ­¤æ¦œå•å½±ç‰‡' : 'ğŸ˜” æš‚æ— æ’è¡Œæ•°æ®',
                    'fa-trophy'
                );
                return;
            }
            
            container.innerHTML = `
                <div class="rank-grid">
                    ${filteredRankings.map((movie, index) => createRankCard(movie, index + 1)).join('')}
                </div>
            `;
        }
        
        // åˆ›å»ºæ’è¡Œå¡ç‰‡
        function createRankCard(movie, rank) {
            const hasLocal = movie.local_exists || false;  // ä½¿ç”¨APIè¿”å›çš„local_existså­—æ®µ
            const isSelected = selectedMovies.has(movie.code);
            const task = downloadTasks.get(movie.code);
            
            return `
                <div class="glass-card hover-scale relative ${isSelected ? 'ring-2 ring-primary' : ''}">
                    <!-- æ’åå¾½ç«  -->
                    <div class="rank-badge ${rank <= 3 ? `rank-${rank}` : 'rank-other'}">
                        ${rank <= 3 ? `ğŸ…` : rank}
                    </div>
                    
                    <!-- é€‰æ‹©æ¡†ï¼ˆåªæœ‰ä¸åœ¨æœ¬åœ°åº“çš„æ‰æ˜¾ç¤ºï¼‰ -->
                    ${!hasLocal && !task ? `
                        <div class="absolute top-2 right-2 z-10">
                            <input type="checkbox" 
                                   ${isSelected ? 'checked' : ''} 
                                   onchange="toggleSelection('${movie.code}')"
                                   class="w-5 h-5 rounded cursor-pointer">
                        </div>
                    ` : ''}
                    
                    <!-- å½±ç‰‡å†…å®¹ -->
                    <div class="cursor-pointer" onclick="viewMovieDetail('${movie.code}')">
                        <div class="relative overflow-hidden" style="aspect-ratio: 3/4;">
                            ${movie.cover_url ? `
                                <img src="${movie.cover_url}" alt="${movie.title}" 
                                     class="w-full h-full object-cover" loading="lazy">
                            ` : `
                                <div class="skeleton-image"></div>
                            `}
                            
                            <!-- çŠ¶æ€æ ‡ç­¾ -->
                            <div class="absolute bottom-2 left-2 right-2 flex justify-between items-end">
                                ${getStatusBadge(hasLocal, task)}
                                ${movie.is_hot ? `
                                    <span class="badge badge-danger">ğŸ”¥ çƒ­é—¨</span>
                                ` : ''}
                                ${movie.is_new ? `
                                    <span class="badge badge-warning">ğŸ†• æ–°ä½œ</span>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="p-4">
                            <h3 class="font-semibold text-sm mb-2 line-clamp-2">
                                ${movie.title || movie.code}
                            </h3>
                            <div class="space-y-1 text-xs text-muted">
                                <p>ğŸ¬ ${movie.code}</p>
                                ${movie.actresses ? `
                                    <p>ğŸ‘¤ ${movie.actresses.slice(0, 2).join(', ')}</p>
                                ` : ''}
                                ${movie.release_date ? `
                                    <p>ğŸ“… ${movie.release_date}</p>
                                ` : ''}
                                ${movie.score ? `
                                    <p>â­ ${movie.score} åˆ†</p>
                                ` : ''}
                            </div>
                            
                            <!-- ä¸‹è½½è¿›åº¦æ¡ï¼ˆå¦‚æœæœ‰ä»»åŠ¡åœ¨è¿›è¡Œä¸­ï¼‰ -->
                            ${task && task.status === 'progress' ? `
                                <div class="mt-2">
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-primary-gradient h-2 rounded-full transition-all duration-300" 
                                             style="width: ${Math.round(task.progress * 100)}%"></div>
                                    </div>
                                    <p class="text-xs text-center mt-1">${Math.round(task.progress * 100)}%</p>
                                </div>
                            ` : ''}
                            
                            <!-- æ“ä½œæŒ‰é’® -->
                            ${getActionButton(hasLocal, task, movie.code)}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // è·å–çŠ¶æ€æ ‡ç­¾
        function getStatusBadge(hasLocal, task) {
            if (hasLocal) {
                return '<span class="badge badge-success">âœ… å·²åœ¨åº“ä¸­</span>';
            }
            
            if (task) {
                switch (task.status) {
                    case 'pending':
                        return '<span class="badge badge-info">â³ ç­‰å¾…ä¸­</span>';
                    case 'searching':
                        return '<span class="badge badge-info">ğŸ” æœç´¢ç§å­</span>';
                    case 'found':
                        return '<span class="badge badge-warning">ğŸ“ ç§å­å·²æ‰¾åˆ°</span>';
                    case 'started':
                        return '<span class="badge badge-primary">ğŸ“¥ ä¸‹è½½ä¸­</span>';
                    case 'progress':
                        return '<span class="badge badge-primary">ğŸ“¥ ä¸‹è½½ä¸­</span>';
                    case 'completed':
                        return '<span class="badge badge-success">âœ… å·²å®Œæˆ</span>';
                    case 'failed':
                        return '<span class="badge badge-error">âŒ å¤±è´¥</span>';
                    case 'cancelled':
                        return '<span class="badge badge-warning">â¹ï¸ å·²å–æ¶ˆ</span>';
                    default:
                        return '<span class="badge badge-warning">ğŸ“¥ å¯ä¸‹è½½</span>';
                }
            }
            
            return '<span class="badge badge-warning">ğŸ“¥ å¯ä¸‹è½½</span>';
        }
        
        // è·å–æ“ä½œæŒ‰é’®
        function getActionButton(hasLocal, task, code) {
            if (hasLocal) {
                return `
                    <button class="btn btn-secondary btn-sm w-full mt-3" disabled>
                        âœ… å·²åœ¨æœ¬åœ°
                    </button>
                `;
            }
            
            if (task) {
                switch (task.status) {
                    case 'pending':
                    case 'searching':
                    case 'found':
                    case 'started':
                    case 'progress':
                        return `
                            <button onclick="event.stopPropagation(); cancelDownload('${code}')" 
                                    class="btn btn-warning btn-sm w-full mt-3">
                                <i class="fas fa-stop"></i>
                                å–æ¶ˆä¸‹è½½
                            </button>
                        `;
                    case 'completed':
                        return `
                            <button class="btn btn-success btn-sm w-full mt-3" disabled>
                                âœ… ä¸‹è½½å®Œæˆ
                            </button>
                        `;
                    case 'failed':
                        return `
                            <button onclick="event.stopPropagation(); retryDownload('${code}')" 
                                    class="btn btn-error btn-sm w-full mt-3">
                                <i class="fas fa-redo"></i>
                                é‡è¯•
                            </button>
                        `;
                    case 'cancelled':
                        return `
                            <button onclick="event.stopPropagation(); downloadSingle('${code}')" 
                                    class="btn btn-primary btn-sm w-full mt-3">
                                <i class="fas fa-download"></i>
                                é‡æ–°ä¸‹è½½
                            </button>
                        `;
                }
            }
            
            return `
                <button onclick="event.stopPropagation(); downloadSingle('${code}')" 
                        class="btn btn-primary btn-sm w-full mt-3">
                    <i class="fas fa-download"></i>
                    ä¸‹è½½
                </button>
            `;
        }
        
        // åˆ‡æ¢æ’è¡Œæ¦œç±»å‹
        function switchRankType(type) {
            currentRankType = type;
            
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.rank-type-tab').forEach(tab => {
                tab.classList.remove('active', 'btn-primary');
                tab.classList.add('btn-secondary');
            });
            
            const activeTab = document.getElementById(`${type}Tab`);
            activeTab.classList.add('active', 'btn-primary');
            activeTab.classList.remove('btn-secondary');
            
            // åŠ è½½å¯¹åº”æ’è¡Œæ¦œ
            loadRankings(type);
        }
        
        // åˆ·æ–°æ’è¡Œæ¦œ
        async function refreshRankings() {
            components.showNotification('ğŸ”„ æ­£åœ¨å…¨é¢åˆ·æ–°ï¼šæ’è¡Œæ¦œ + æœ¬åœ°åº“ + å¯¹æ¯”æ£€æŸ¥...', 'info');

            try {
                // ç¬¬ä¸€æ­¥ï¼šè§¦å‘æœ¬åœ°åº“æ‰«æ
                components.showNotification('ğŸ“ æ­£åœ¨æ‰«ææœ¬åœ°åº“...', 'info');
                const scanResponse = await fetch('/api/v1/local/scan', { method: 'POST' });
                const scanData = await scanResponse.json();

                if (scanData.success) {
                    components.showNotification('âœ… æœ¬åœ°åº“æ‰«æå®Œæˆ', 'success');
                } else {
                    components.showNotification('âš ï¸ æœ¬åœ°åº“æ‰«æå¤±è´¥ï¼Œç»§ç»­æ’è¡Œæ¦œåˆ·æ–°', 'warning');
                }

                // ç¬¬äºŒæ­¥ï¼šè§¦å‘æ’è¡Œæ¦œçˆ¬å–
                components.showNotification('ğŸ† æ­£åœ¨åˆ·æ–°æ’è¡Œæ¦œ...', 'info');
                const crawlResponse = await fetch('/api/v1/rankings/crawl', { method: 'POST' });
                const crawlData = await crawlResponse.json();

                if (crawlData.success === true) {
                    components.showNotification('âœ… æ’è¡Œæ¦œå·²æ›´æ–°ï¼', 'success');
                } else {
                    components.showNotification('âš ï¸ æ’è¡Œæ¦œåˆ·æ–°å¤±è´¥ï¼Œç»§ç»­æœ¬åœ°æ£€æŸ¥', 'warning');
                }

                // ç¬¬ä¸‰æ­¥ï¼šè§¦å‘æœ¬åœ°å­˜åœ¨æ£€æŸ¥
                components.showNotification('ğŸ” æ­£åœ¨æ£€æŸ¥æœ¬åœ°å­˜åœ¨çŠ¶æ€...', 'info');
                const checkResponse = await fetch('/api/v1/rankings/check', { method: 'POST' });
                const checkData = await checkResponse.json();

                if (checkData.success === true) {
                    components.showNotification('âœ… æœ¬åœ°å­˜åœ¨æ£€æŸ¥å®Œæˆï¼', 'success');
                } else {
                    components.showNotification('âš ï¸ æœ¬åœ°å­˜åœ¨æ£€æŸ¥å¤±è´¥', 'warning');
                }

                // ç¬¬å››æ­¥ï¼šé‡æ–°åŠ è½½æ•°æ®
                components.showNotification('ğŸ“Š æ­£åœ¨é‡æ–°åŠ è½½æ’è¡Œæ¦œæ•°æ®...', 'info');
                setTimeout(() => {
                    loadRankings(currentRankType);
                    components.showNotification('ğŸ‰ å…¨é¢åˆ·æ–°å®Œæˆï¼', 'success');
                }, 3000); // ç»™åç«¯æœåŠ¡æ›´å¤šæ—¶é—´å®Œæˆå¤„ç†

            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
                components.showNotification('ğŸ˜… åˆ·æ–°è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ' + error.message, 'error');
            }
        }
        
        // ç­›é€‰æ’è¡Œæ¦œ
        function filterRankings() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            filteredRankings = allRankings.filter(movie => {
                if (localOnlyMode && !movie.local_exists) return false;
                
                const title = (movie.title || '').toLowerCase();
                const code = (movie.code || '').toLowerCase();
                const actresses = (movie.actresses || []).join(' ').toLowerCase();
                
                return title.includes(searchTerm) || 
                       code.includes(searchTerm) || 
                       actresses.includes(searchTerm);
            });
            
            renderRankings();
        }
        
        // åˆ‡æ¢åªçœ‹æœ¬åœ°
        function toggleLocalOnly() {
            localOnlyMode = !localOnlyMode;
            const btn = document.getElementById('localOnlyBtn');
            
            if (localOnlyMode) {
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
            } else {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            }
            
            filterRankings();
        }
        
        // åˆ‡æ¢é€‰æ‹©
        function toggleSelection(code) {
            if (selectedMovies.has(code)) {
                selectedMovies.delete(code);
            } else {
                selectedMovies.add(code);
            }
            renderRankings();
        }
        
        // æ‰¹é‡ä¸‹è½½
        function batchDownload() {
            if (selectedMovies.size === 0) {
                components.showNotification('ğŸ˜… è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„å½±ç‰‡', 'warning');
                return;
            }
            
            components.showNotification(`ğŸš€ å¼€å§‹æ‰¹é‡ä¸‹è½½ ${selectedMovies.size} éƒ¨å½±ç‰‡...`, 'info');
            
            // è·³è½¬åˆ°ä¸‹è½½é¡µé¢
            const codes = Array.from(selectedMovies).join(',');
            window.location.href = `/downloads.html?batch=${codes}`;
        }
        
        // å•ä¸ªä¸‹è½½ - ä½¿ç”¨æ–°çš„æ’è¡Œæ¦œä¸‹è½½API
        async function downloadSingle(code) {
            if (!code) return;
            
            // ä»æ’è¡Œæ¦œä¸­è·å–å½±ç‰‡ä¿¡æ¯
            const movie = allRankings.find(m => m.code === code);
            
            components.showNotification('ğŸš€ æ­£åœ¨å¯åŠ¨ä¸‹è½½ä»»åŠ¡...', 'info');
            
            try {
                const response = await fetch('/api/v1/rankings/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        title: movie?.title || code,
                        source: 'manual',
                        rank_type: currentRankType
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'å¯åŠ¨ä¸‹è½½ä»»åŠ¡å¤±è´¥');
                }
                
                // ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œæ·»åŠ åˆ°æœ¬åœ°çŠ¶æ€
                downloadTasks.set(code, {
                    id: data.data.id,
                    code: code,
                    status: data.data.status,
                    progress: data.data.progress || 0,
                    error_msg: data.data.error_msg || ''
                });
                
                // é‡æ–°æ¸²æŸ“ç•Œé¢
                renderRankings();
                
                components.showNotification('âœ… ä¸‹è½½ä»»åŠ¡å·²å¯åŠ¨ï¼Œæ­£åœ¨åå°å¤„ç†...', 'success');
                
            } catch (error) {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                components.showNotification(`âŒ ä¸‹è½½å¤±è´¥: ${error.message}`, 'error', 10000);
            }
        }
        
        // å–æ¶ˆä¸‹è½½
        async function cancelDownload(code) {
            const task = downloadTasks.get(code);
            if (!task) return;
            
            try {
                const response = await fetch(`/api/v1/rankings/download-tasks/${task.id}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    components.showNotification('â¹ï¸ ä»»åŠ¡å·²å–æ¶ˆ', 'info');
                    downloadTasks.set(code, { ...task, status: 'cancelled' });
                    renderRankings();
                } else {
                    throw new Error(data.error || 'å–æ¶ˆä»»åŠ¡å¤±è´¥');
                }
            } catch (error) {
                console.error('å–æ¶ˆå¤±è´¥:', error);
                components.showNotification(`âŒ å–æ¶ˆå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é‡è¯•ä¸‹è½½
        async function retryDownload(code) {
            const task = downloadTasks.get(code);
            if (!task) return;
            
            try {
                const response = await fetch(`/api/v1/rankings/download-tasks/${task.id}/retry`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    components.showNotification('ğŸ”„ ä»»åŠ¡å·²é‡æ–°å¯åŠ¨', 'info');
                    downloadTasks.set(code, { ...task, status: 'pending', progress: 0, error_msg: '' });
                    renderRankings();
                } else {
                    throw new Error(data.error || 'é‡è¯•ä»»åŠ¡å¤±è´¥');
                }
            } catch (error) {
                console.error('é‡è¯•å¤±è´¥:', error);
                components.showNotification(`âŒ é‡è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æŸ¥çœ‹å½±ç‰‡è¯¦æƒ…
        async function viewMovieDetail(code) {
            currentMovie = allRankings.find(m => m.code === code);
            if (!currentMovie) return;
            
            const modal = document.getElementById('movieDetailModal');
            const content = document.getElementById('movieDetailContent');
            
            content.innerHTML = `
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="md:w-1/3">
                        ${currentMovie.cover_url ? `
                            <img src="${currentMovie.cover_url}" alt="${currentMovie.title}" 
                                 class="w-full rounded-lg">
                        ` : `
                            <div class="skeleton-image rounded-lg"></div>
                        `}
                    </div>
                    <div class="md:w-2/3 space-y-4">
                        <h2 class="text-2xl font-bold">${currentMovie.title || currentMovie.code}</h2>
                        <div class="space-y-2 text-sm">
                            <p><strong>ğŸ¬ ç•ªå·ï¼š</strong>${currentMovie.code}</p>
                            ${currentMovie.actresses ? `
                                <p><strong>ğŸ‘¤ å¥³ä¼˜ï¼š</strong>${currentMovie.actresses.join(', ')}</p>
                            ` : ''}
                            ${currentMovie.release_date ? `
                                <p><strong>ğŸ“… å‘è¡Œæ—¥æœŸï¼š</strong>${currentMovie.release_date}</p>
                            ` : ''}
                            ${currentMovie.studio ? `
                                <p><strong>ğŸ¢ åˆ¶ä½œå•†ï¼š</strong>${currentMovie.studio}</p>
                            ` : ''}
                            ${currentMovie.duration ? `
                                <p><strong>â±ï¸ æ—¶é•¿ï¼š</strong>${currentMovie.duration} åˆ†é’Ÿ</p>
                            ` : ''}
                            ${currentMovie.score ? `
                                <p><strong>â­ è¯„åˆ†ï¼š</strong>${currentMovie.score}</p>
                            ` : ''}
                        </div>
                        ${currentMovie.description ? `
                            <div>
                                <h3 class="font-semibold mb-2">ğŸ“ ç®€ä»‹</h3>
                                <p class="text-sm text-muted">${currentMovie.description}</p>
                            </div>
                        ` : ''}
                        ${currentMovie.tags ? `
                            <div>
                                <h3 class="font-semibold mb-2">ğŸ·ï¸ æ ‡ç­¾</h3>
                                <div class="flex flex-wrap gap-2">
                                    ${currentMovie.tags.map(tag => `
                                        <span class="badge badge-primary">${tag}</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // æ›´æ–°ä¸‹è½½æŒ‰é’®
            const downloadBtn = document.getElementById('downloadBtn');
            if (currentMovie.has_local) {
                downloadBtn.disabled = true;
                downloadBtn.innerHTML = 'âœ… å·²åœ¨æœ¬åœ°';
            } else {
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = '<i class="fas fa-download"></i> ä¸‹è½½';
            }
            
            components.openModal('movieDetailModal');
        }
        
        // å…³é—­è¯¦æƒ…
        function closeMovieDetail() {
            components.closeModal();
            currentMovie = null;
        }
        
        // ä¸‹è½½å½±ç‰‡
        function downloadMovie() {
            if (currentMovie && !currentMovie.has_local) {
                downloadSingle(currentMovie.code);
            }
        }
        
        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            const localCount = allRankings.filter(m => m.local_exists).length;
            const downloadableCount = allRankings.filter(m => !m.local_exists).length;

            document.getElementById('localCount').textContent = localCount;
            document.getElementById('downloadableCount').textContent = downloadableCount;
        }
        
        // å¯åŠ¨çŠ¶æ€æ›´æ–°å®šæ—¶å™¨
        function startStatusUpdates() {
            // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
            
            // ç«‹å³æ‰§è¡Œä¸€æ¬¡çŠ¶æ€æ›´æ–°
            updateDownloadStatus();
            
            // è®¾ç½®30ç§’å®šæ—¶æ›´æ–°
            statusUpdateInterval = setInterval(updateDownloadStatus, 30000);
        }
        
        // æ›´æ–°ä¸‹è½½çŠ¶æ€
        async function updateDownloadStatus() {
            try {
                // è·å–æ‰€æœ‰ä¸‹è½½ä»»åŠ¡
                const response = await fetch('/api/v1/rankings/download-tasks?limit=100');
                const data = await response.json();
                
                if (data.success && data.data.tasks) {
                    let hasUpdates = false;
                    
                    data.data.tasks.forEach(task => {
                        const existingTask = downloadTasks.get(task.code);
                        
                        // æ£€æŸ¥çŠ¶æ€æ˜¯å¦å‘ç”Ÿå˜åŒ–
                        if (!existingTask || existingTask.status !== task.status || existingTask.progress !== task.progress) {
                            hasUpdates = true;
                        }
                        
                        downloadTasks.set(task.code, {
                            id: task.id,
                            code: task.code,
                            status: task.status,
                            progress: task.progress || 0,
                            error_msg: task.error_msg || ''
                        });
                    });
                    
                    // å¦‚æœæœ‰æ›´æ–°ï¼Œé‡æ–°æ¸²æŸ“ç•Œé¢
                    if (hasUpdates) {
                        renderRankings();
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰æ–°å®Œæˆçš„ä»»åŠ¡
                        const completedTasks = data.data.tasks.filter(task => task.status === 'completed');
                        completedTasks.forEach(task => {
                            if (!downloadTasks.has(task.code) || downloadTasks.get(task.code).status !== 'completed') {
                                components.showNotification(`ğŸ‰ ${task.code} ä¸‹è½½å®Œæˆï¼`, 'success', 5000);
                            }
                        });
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰æ–°å¤±è´¥çš„ä»»åŠ¡
                        const failedTasks = data.data.tasks.filter(task => task.status === 'failed');
                        failedTasks.forEach(task => {
                            if (!downloadTasks.has(task.code) || downloadTasks.get(task.code).status !== 'failed') {
                                components.showNotification(`âŒ ${task.code} ä¸‹è½½å¤±è´¥: ${task.error_msg}`, 'error', 8000);
                            }
                        });
                    }
                }
            } catch (error) {
                console.warn('çŠ¶æ€æ›´æ–°å¤±è´¥:', error);
            }
        }
        
        // è¿”å›é¡¶éƒ¨
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
    
    <!-- å¼•å…¥å¤–éƒ¨rankings.js -->
    <script src="static/js/rankings.js"></script>
</body>
</html>