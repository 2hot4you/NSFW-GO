<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🏆 影片排行榜 - NSFW-Go</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="static/css/design-system.css">
    <link rel="stylesheet" href="static/css/components.css">
    <style>
        /* 页面特定样式 */
        .rankings-container {
            min-height: calc(100vh - 64px);
            padding: 2rem 1rem;
        }
        
        .rank-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.5rem;
        }
        
        @media (max-width: 640px) {
            .rank-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .rank-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
        
        .rank-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 20;
        }
        
        .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); }
        .rank-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
        .rank-3 { background: linear-gradient(135deg, #CD7F32, #B87333); }
        .rank-other { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); }
        
        .rank-type-tab {
            transition: all 0.3s;
        }
        
        .rank-type-tab.active {
            background: var(--primary-gradient);
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <!-- 导航栏将由modern-nav.js自动插入 -->
    
    <!-- 主内容区 -->
    <main class="rankings-container max-w-7xl mx-auto">
        <!-- 页面头部 -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4">
                <span class="glow-text">🏆 影片排行榜</span>
            </h1>
            <p class="text-lg text-muted">JAVDb 热门影片排行，每日更新最受欢迎的作品 🔥</p>
        </div>
        
        <!-- 排行榜类型切换 -->
        <div class="glass-card p-6 mb-8">
            <div class="flex flex-wrap gap-3 justify-center">
                <button onclick="switchRankType('daily')" class="btn btn-primary rank-type-tab active" id="dailyTab">
                    <i class="fas fa-calendar-day"></i>
                    <span>📅 日榜</span>
                </button>
                <button onclick="switchRankType('weekly')" class="btn btn-secondary rank-type-tab" id="weeklyTab">
                    <i class="fas fa-calendar-week"></i>
                    <span>📆 周榜</span>
                </button>
                <button onclick="switchRankType('monthly')" class="btn btn-secondary rank-type-tab" id="monthlyTab">
                    <i class="fas fa-calendar-alt"></i>
                    <span>📊 月榜</span>
                </button>
                <button onclick="refreshRankings()" class="btn btn-secondary ml-auto">
                    <i class="fas fa-sync-alt"></i>
                    <span>🔄 刷新</span>
                </button>
            </div>
            
            <!-- 统计信息 -->
            <div class="mt-4 flex flex-wrap gap-4 justify-center text-sm">
                <div class="badge badge-success">
                    ✅ 本地已有：<span id="localCount">0</span> 部
                </div>
                <div class="badge badge-warning">
                    📥 可下载：<span id="downloadableCount">0</span> 部
                </div>
                <div class="badge badge-primary">
                    ⏰ 更新时间：<span id="updateTime">--</span>
                </div>
            </div>
        </div>
        
        <!-- 筛选和搜索 -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
            <div class="flex-1">
                <div class="relative">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="🔍 搜索排行榜..." 
                        class="input-field pl-10"
                        onkeyup="filterRankings()"
                    >
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-muted"></i>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleLocalOnly()" class="btn btn-secondary" id="localOnlyBtn">
                    <i class="fas fa-home"></i>
                    <span>只看本地</span>
                </button>
                <button onclick="batchDownload()" class="btn btn-primary">
                    <i class="fas fa-download"></i>
                    <span>批量下载</span>
                </button>
            </div>
        </div>
        
        <!-- 排行榜内容 -->
        <div id="rankingsContainer">
            <div class="loading-state flex-center" style="min-height: 400px;">
                <div class="loader"></div>
                <span class="loading-message ml-3">加载排行榜...</span>
            </div>
        </div>
    </main>
    
    <!-- 影片详情模态框 -->
    <div id="movieDetailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">🎬 影片详情</h3>
                <button onclick="closeMovieDetail()" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="movieDetailContent">
                <!-- 详情内容将动态插入 -->
            </div>
            <div class="modal-footer">
                <button onclick="closeMovieDetail()" class="btn btn-secondary">关闭</button>
                <button onclick="downloadMovie()" class="btn btn-primary" id="downloadBtn">
                    <i class="fas fa-download"></i>
                    下载
                </button>
            </div>
        </div>
    </div>
    
    <!-- 返回顶部 -->
    <button id="backToTop" onclick="scrollToTop()" class="fixed bottom-8 right-8 btn btn-primary rounded-full w-12 h-12 hidden">
        <i class="fas fa-arrow-up"></i>
    </button>
    
    <script src="static/js/components.js"></script>
    <script src="static/js/modern-nav.js"></script>
    <script src="static/js/performance.js"></script>
    <script>
        let currentRankType = 'daily';
        let allRankings = [];
        let filteredRankings = [];
        let localOnlyMode = false;
        let selectedMovies = new Set();
        let currentMovie = null;
        
        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            loadRankings('daily');
            
            // 监听滚动
            window.addEventListener('scroll', () => {
                const backToTop = document.getElementById('backToTop');
                if (window.scrollY > 300) {
                    backToTop.classList.remove('hidden');
                } else {
                    backToTop.classList.add('hidden');
                }
            });
        });
        
        // 加载排行榜
        async function loadRankings(type) {
            const container = document.getElementById('rankingsContainer');
            container.innerHTML = components.createLoadingState('🏆 加载排行榜中...');
            
            try {
                // API 返回所有排行榜数据，需要在前端过滤
                const response = await fetch('/api/v1/rankings');
                const data = await response.json();
                
                if (data.success && data.data) {
                    // 过滤出对应类型的排行榜
                    allRankings = data.data.filter(item => item.rank_type === type);
                    // 按排名排序
                    allRankings.sort((a, b) => a.position - b.position);
                    filteredRankings = [...allRankings];
                    renderRankings();
                    updateStats();
                    
                    // 更新时间
                    document.getElementById('updateTime').textContent = 
                        new Date().toLocaleTimeString('zh-CN');
                } else {
                    throw new Error('加载失败');
                }
            } catch (error) {
                console.error('加载排行榜失败:', error);
                container.innerHTML = components.createEmptyState(
                    '😅 加载排行榜失败',
                    'fa-trophy',
                    {
                        label: '重试',
                        icon: 'fas fa-sync',
                        onClick: `loadRankings('${type}')`
                    }
                );
            }
        }
        
        // 渲染排行榜
        function renderRankings() {
            const container = document.getElementById('rankingsContainer');
            
            if (filteredRankings.length === 0) {
                container.innerHTML = components.createEmptyState(
                    localOnlyMode ? '😔 本地暂无此榜单影片' : '😔 暂无排行数据',
                    'fa-trophy'
                );
                return;
            }
            
            container.innerHTML = `
                <div class="rank-grid">
                    ${filteredRankings.map((movie, index) => createRankCard(movie, index + 1)).join('')}
                </div>
            `;
        }
        
        // 创建排行卡片
        function createRankCard(movie, rank) {
            const hasLocal = movie.local_exists || false;  // 使用API返回的local_exists字段
            const isSelected = selectedMovies.has(movie.code);
            
            return `
                <div class="glass-card hover-scale relative ${isSelected ? 'ring-2 ring-primary' : ''}">
                    <!-- 排名徽章 -->
                    <div class="rank-badge ${rank <= 3 ? `rank-${rank}` : 'rank-other'}">
                        ${rank <= 3 ? `🏅` : rank}
                    </div>
                    
                    <!-- 选择框（只有不在本地库的才显示） -->
                    ${!hasLocal ? `
                        <div class="absolute top-2 right-2 z-10">
                            <input type="checkbox" 
                                   ${isSelected ? 'checked' : ''} 
                                   onchange="toggleSelection('${movie.code}')"
                                   class="w-5 h-5 rounded cursor-pointer">
                        </div>
                    ` : ''}
                    
                    <!-- 影片内容 -->
                    <div class="cursor-pointer" onclick="viewMovieDetail('${movie.code}')">
                        <div class="relative overflow-hidden" style="aspect-ratio: 3/4;">
                            ${movie.cover_url ? `
                                <img src="${movie.cover_url}" alt="${movie.title}" 
                                     class="w-full h-full object-cover" loading="lazy">
                            ` : `
                                <div class="skeleton-image"></div>
                            `}
                            
                            <!-- 状态标签 -->
                            <div class="absolute bottom-2 left-2 right-2 flex justify-between items-end">
                                ${hasLocal ? `
                                    <span class="badge badge-success">✅ 已在库中</span>
                                ` : `
                                    <span class="badge badge-warning">📥 可下载</span>
                                `}
                                ${movie.is_hot ? `
                                    <span class="badge badge-danger">🔥 热门</span>
                                ` : ''}
                                ${movie.is_new ? `
                                    <span class="badge badge-warning">🆕 新作</span>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="p-4">
                            <h3 class="font-semibold text-sm mb-2 line-clamp-2">
                                ${movie.title || movie.code}
                            </h3>
                            <div class="space-y-1 text-xs text-muted">
                                <p>🎬 ${movie.code}</p>
                                ${movie.actresses ? `
                                    <p>👤 ${movie.actresses.slice(0, 2).join(', ')}</p>
                                ` : ''}
                                ${movie.release_date ? `
                                    <p>📅 ${movie.release_date}</p>
                                ` : ''}
                                ${movie.score ? `
                                    <p>⭐ ${movie.score} 分</p>
                                ` : ''}
                            </div>
                            
                            <!-- 操作按钮 -->
                            ${!hasLocal ? `
                                <button onclick="event.stopPropagation(); downloadSingle('${movie.code}')" 
                                        class="btn btn-primary btn-sm w-full mt-3">
                                    <i class="fas fa-download"></i>
                                    下载
                                </button>
                            ` : `
                                <button class="btn btn-secondary btn-sm w-full mt-3" disabled>
                                    ✅ 已在本地
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 切换排行榜类型
        function switchRankType(type) {
            currentRankType = type;
            
            // 更新标签样式
            document.querySelectorAll('.rank-type-tab').forEach(tab => {
                tab.classList.remove('active', 'btn-primary');
                tab.classList.add('btn-secondary');
            });
            
            const activeTab = document.getElementById(`${type}Tab`);
            activeTab.classList.add('active', 'btn-primary');
            activeTab.classList.remove('btn-secondary');
            
            // 加载对应排行榜
            loadRankings(type);
        }
        
        // 刷新排行榜
        async function refreshRankings() {
            components.showNotification('🔄 正在刷新排行榜...', 'info');
            
            try {
                const response = await fetch('/api/v1/rankings/crawl', { method: 'POST' });
                const data = await response.json();
                
                if (data.code === 'SUCCESS') {
                    components.showNotification('✅ 排行榜已更新！', 'success');
                    loadRankings(currentRankType);
                } else {
                    components.showNotification('😅 刷新失败', 'error');
                }
            } catch (error) {
                console.error('刷新失败:', error);
                components.showNotification('😅 刷新失败', 'error');
            }
        }
        
        // 筛选排行榜
        function filterRankings() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredRankings = allRankings.filter(movie => {
                if (localOnlyMode && !movie.has_local) return false;
                
                const title = (movie.title || '').toLowerCase();
                const code = (movie.code || '').toLowerCase();
                const actresses = (movie.actresses || []).join(' ').toLowerCase();
                
                return title.includes(searchTerm) || 
                       code.includes(searchTerm) || 
                       actresses.includes(searchTerm);
            });
            
            renderRankings();
        }
        
        // 切换只看本地
        function toggleLocalOnly() {
            localOnlyMode = !localOnlyMode;
            const btn = document.getElementById('localOnlyBtn');
            
            if (localOnlyMode) {
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
            } else {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            }
            
            filterRankings();
        }
        
        // 切换选择
        function toggleSelection(code) {
            if (selectedMovies.has(code)) {
                selectedMovies.delete(code);
            } else {
                selectedMovies.add(code);
            }
            renderRankings();
        }
        
        // 批量下载
        function batchDownload() {
            if (selectedMovies.size === 0) {
                components.showNotification('😅 请先选择要下载的影片', 'warning');
                return;
            }
            
            components.showNotification(`🚀 开始批量下载 ${selectedMovies.size} 部影片...`, 'info');
            
            // 跳转到下载页面
            const codes = Array.from(selectedMovies).join(',');
            window.location.href = `/downloads.html?batch=${codes}`;
        }
        
        // 单个下载
        function downloadSingle(code) {
            window.location.href = `/downloads.html?search=${code}`;
        }
        
        // 查看影片详情
        async function viewMovieDetail(code) {
            currentMovie = allRankings.find(m => m.code === code);
            if (!currentMovie) return;
            
            const modal = document.getElementById('movieDetailModal');
            const content = document.getElementById('movieDetailContent');
            
            content.innerHTML = `
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="md:w-1/3">
                        ${currentMovie.cover_url ? `
                            <img src="${currentMovie.cover_url}" alt="${currentMovie.title}" 
                                 class="w-full rounded-lg">
                        ` : `
                            <div class="skeleton-image rounded-lg"></div>
                        `}
                    </div>
                    <div class="md:w-2/3 space-y-4">
                        <h2 class="text-2xl font-bold">${currentMovie.title || currentMovie.code}</h2>
                        <div class="space-y-2 text-sm">
                            <p><strong>🎬 番号：</strong>${currentMovie.code}</p>
                            ${currentMovie.actresses ? `
                                <p><strong>👤 女优：</strong>${currentMovie.actresses.join(', ')}</p>
                            ` : ''}
                            ${currentMovie.release_date ? `
                                <p><strong>📅 发行日期：</strong>${currentMovie.release_date}</p>
                            ` : ''}
                            ${currentMovie.studio ? `
                                <p><strong>🏢 制作商：</strong>${currentMovie.studio}</p>
                            ` : ''}
                            ${currentMovie.duration ? `
                                <p><strong>⏱️ 时长：</strong>${currentMovie.duration} 分钟</p>
                            ` : ''}
                            ${currentMovie.score ? `
                                <p><strong>⭐ 评分：</strong>${currentMovie.score}</p>
                            ` : ''}
                        </div>
                        ${currentMovie.description ? `
                            <div>
                                <h3 class="font-semibold mb-2">📝 简介</h3>
                                <p class="text-sm text-muted">${currentMovie.description}</p>
                            </div>
                        ` : ''}
                        ${currentMovie.tags ? `
                            <div>
                                <h3 class="font-semibold mb-2">🏷️ 标签</h3>
                                <div class="flex flex-wrap gap-2">
                                    ${currentMovie.tags.map(tag => `
                                        <span class="badge badge-primary">${tag}</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // 更新下载按钮
            const downloadBtn = document.getElementById('downloadBtn');
            if (currentMovie.has_local) {
                downloadBtn.disabled = true;
                downloadBtn.innerHTML = '✅ 已在本地';
            } else {
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = '<i class="fas fa-download"></i> 下载';
            }
            
            components.openModal('movieDetailModal');
        }
        
        // 关闭详情
        function closeMovieDetail() {
            components.closeModal();
            currentMovie = null;
        }
        
        // 下载影片
        function downloadMovie() {
            if (currentMovie && !currentMovie.has_local) {
                downloadSingle(currentMovie.code);
            }
        }
        
        // 更新统计
        function updateStats() {
            const localCount = allRankings.filter(m => m.has_local).length;
            const downloadableCount = allRankings.filter(m => !m.has_local).length;
            
            document.getElementById('localCount').textContent = localCount;
            document.getElementById('downloadableCount').textContent = downloadableCount;
        }
        
        // 返回顶部
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
    
    <!-- 引入外部rankings.js -->
    <script src="static/js/rankings.js"></script>
</body>
</html>