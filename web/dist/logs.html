<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📋 系统日志 - NSFW-Go</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="static/css/design-system.css">
    <link rel="stylesheet" href="static/css/components.css">
    <link rel="stylesheet" href="static/css/tailwind-fixes.css">
    <style>
        /* 页面特定样式 */
        .logs-container {
            min-height: calc(100vh - 64px);
            padding: 2rem 1rem;
        }

        .log-entry {
            font-family: 'Consolas', 'Monaco', 'Lucida Console', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }

        .log-entry:hover {
            background: rgba(255, 255, 255, 0.02);
            border-left-color: var(--primary-light);
        }

        .log-level-info {
            border-left-color: #3b82f6;
        }

        .log-level-warn {
            border-left-color: #f59e0b;
        }

        .log-level-error {
            border-left-color: #ef4444;
        }

        .log-level-debug {
            border-left-color: #8b5cf6;
        }

        .log-timestamp {
            color: #6b7280;
            font-weight: 500;
        }

        .log-level {
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            min-width: 60px;
            text-align: center;
        }

        .log-level.info {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        .log-level.warn {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .log-level.error {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .log-level.debug {
            background: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
        }

        .log-content {
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .filter-active {
            background: rgba(99, 102, 241, 0.2) !important;
            color: #818cf8 !important;
            border-color: rgba(99, 102, 241, 0.3) !important;
        }

        .auto-refresh-indicator {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="min-h-screen overflow-x-hidden">
    <!-- 页面进度条 -->
    <div id="pageProgress" class="page-progress">
        <div></div>
    </div>

    <!-- 主要内容区域 -->
    <main class="page-container-table logs-container">
        <!-- 页面标题 -->
        <div class="flex-between mb-8">
            <div class="fade-in">
                <h1 class="text-2xl font-bold mb-2">
                    <span class="glow-text">📋 系统日志</span>
                </h1>
                <p class="text-secondary">实时查看系统运行日志和错误信息</p>
            </div>

            <!-- 操作按钮 -->
            <div class="flex gap-3">
                <button id="autoRefreshBtn" onclick="toggleAutoRefresh()" class="btn btn-success" title="自动刷新">
                    <div class="auto-refresh-indicator"></div>
                    <span id="autoRefreshText">自动刷新</span>
                </button>
                <button onclick="clearLogs()" class="btn btn-danger" title="清空日志">
                    <i class="fas fa-trash"></i>
                    <span>清空</span>
                </button>
                <button onclick="downloadLogs()" class="btn btn-primary" title="下载日志">
                    <i class="fas fa-download"></i>
                    <span>下载</span>
                </button>
            </div>
        </div>

        <!-- 过滤器和搜索 -->
        <div class="glass-card mb-6 fade-in" style="animation-delay: 0.1s;">
            <div class="flex flex-wrap gap-4 items-center">
                <!-- 日志级别过滤 -->
                <div class="flex gap-2">
                    <span class="text-sm font-medium text-muted">级别:</span>
                    <button onclick="filterByLevel('all')" class="btn btn-sm btn-secondary filter-btn filter-active" data-level="all">
                        全部
                    </button>
                    <button onclick="filterByLevel('info')" class="btn btn-sm btn-secondary filter-btn" data-level="info">
                        INFO
                    </button>
                    <button onclick="filterByLevel('warn')" class="btn btn-sm btn-secondary filter-btn" data-level="warn">
                        WARN
                    </button>
                    <button onclick="filterByLevel('error')" class="btn btn-sm btn-secondary filter-btn" data-level="error">
                        ERROR
                    </button>
                    <button onclick="filterByLevel('debug')" class="btn btn-sm btn-secondary filter-btn" data-level="debug">
                        DEBUG
                    </button>
                </div>

                <!-- 日志分类过滤 -->
                <div class="flex gap-2">
                    <span class="text-sm font-medium text-muted">分类:</span>
                    <button onclick="filterByCategory('all')" class="btn btn-sm btn-secondary category-btn filter-active" data-category="all">
                        全部
                    </button>
                    <button onclick="filterByCategory('system')" class="btn btn-sm btn-secondary category-btn" data-category="system">
                        系统
                    </button>
                    <button onclick="filterByCategory('crawler')" class="btn btn-sm btn-secondary category-btn" data-category="crawler">
                        爬虫
                    </button>
                    <button onclick="filterByCategory('scanner')" class="btn btn-sm btn-secondary category-btn" data-category="scanner">
                        扫描
                    </button>
                    <button onclick="filterByCategory('torrent')" class="btn btn-sm btn-secondary category-btn" data-category="torrent">
                        下载
                    </button>
                    <button onclick="filterByCategory('config')" class="btn btn-sm btn-secondary category-btn" data-category="config">
                        配置
                    </button>
                </div>

                <!-- 搜索框 -->
                <div class="flex-1 min-w-64">
                    <div class="input-group">
                        <input
                            type="text"
                            id="searchInput"
                            placeholder="搜索日志内容..."
                            class="input-field"
                            oninput="searchLogs()"
                        >
                        <button class="input-group-btn" onclick="searchLogs()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 日志统计 -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 fade-in" style="animation-delay: 0.2s;" id="logStats">
            <!-- 统计卡片将通过JS动态生成 -->
        </div>

        <!-- 日志列表 -->
        <div class="glass-card fade-in" style="animation-delay: 0.3s;">
            <div class="card-header">
                <div class="flex-between">
                    <h3 class="card-title">
                        <i class="fas fa-list-alt text-primary-light"></i>
                        实时日志
                    </h3>
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-muted" id="logCount">共 0 条</span>
                        <button onclick="refreshLogs()" class="btn btn-sm btn-primary">
                            <i class="fas fa-sync-alt" id="refreshIcon"></i>
                            刷新
                        </button>
                    </div>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="col-time">时间</th>
                                <th class="col-level">级别</th>
                                <th class="col-module">模块</th>
                                <th class="col-action">操作</th>
                                <th class="col-message">消息</th>
                            </tr>
                        </thead>
                        <tbody id="logsContainer">
                            <!-- 日志内容将通过JS动态生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        // 全局变量
        let currentLogs = [];
        let filteredLogs = [];
        let currentStats = {};
        let currentLevelFilter = 'all';
        let currentCategoryFilter = 'all';
        let autoRefreshInterval = null;
        let isAutoRefresh = true;
        let isFirstLoad = true;

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            initLogsPage();
            loadLogs();
            startAutoRefresh();
        });

        // 初始化日志页面
        function initLogsPage() {
            // 设置页面加载进度
            const progress = document.querySelector('#pageProgress > div');
            if (progress) {
                progress.style.width = '50%';
                setTimeout(() => progress.style.width = '100%', 500);
                setTimeout(() => document.getElementById('pageProgress').style.display = 'none', 1000);
            }
        }

        // 加载日志数据
        async function loadLogs() {
            const container = document.getElementById('logsContainer');

            // 显示加载状态
            if (!currentLogs.length) {
                container.innerHTML = components.createLoadingState('加载日志数据...');
            }

            try {
                const response = await fetch('/api/v1/logs');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.success && data.data) {
                    currentLogs = data.data;
                    // 使用从API返回的统计信息
                    if (data.meta && data.meta.stats) {
                        currentStats = data.meta.stats;
                    }
                    applyFilters();
                    updateLogStats();
                    renderLogs();

                    if (!isFirstLoad) {
                        components.showNotification('日志已刷新', 'success');
                    }
                    isFirstLoad = false;
                } else {
                    throw new Error(data.message || '返回数据格式错误');
                }
            } catch (error) {
                console.error('获取日志失败:', error);

                // 模拟日志数据用于演示
                currentLogs = generateMockLogs();
                applyFilters();
                updateLogStats();
                renderLogs();

                components.showNotification('无法连接到日志服务，正在使用模拟数据', 'warning');
            }
        }

        // 生成模拟日志数据
        function generateMockLogs() {
            const levels = ['info', 'warn', 'error', 'debug'];
            const categories = ['system', 'crawler', 'scanner', 'torrent', 'config'];
            const mockLogs = [];

            const messages = {
                system: ['服务器启动完成', '数据库连接成功', 'API服务已就绪', '健康检查通过'],
                crawler: ['开始爬取JAVDb排行榜', '爬取完成，共获取123条数据', '遇到反爬虫限制，等待重试', '排行榜数据已更新'],
                scanner: ['开始扫描本地媒体库', '发现新文件：SONE-123.mp4', '扫描完成，共处理456个文件', '跳过重复文件'],
                torrent: ['添加下载任务成功', '种子搜索完成', '下载进度：45%', 'qBittorrent连接测试成功'],
                config: ['配置已更新', '数据库配置备份完成', '连接测试成功', '工作模式已切换']
            };

            for (let i = 0; i < 50; i++) {
                const category = categories[Math.floor(Math.random() * categories.length)];
                const level = levels[Math.floor(Math.random() * levels.length)];
                const timestamp = new Date(Date.now() - Math.random() * 24 * 60 * 60 * 1000);
                const message = messages[category][Math.floor(Math.random() * messages[category].length)];

                mockLogs.push({
                    id: i + 1,
                    timestamp: timestamp.toISOString(),
                    level: level,
                    category: category,
                    message: message,
                    source: `${category}-service`
                });
            }

            return mockLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        // 应用过滤器
        function applyFilters() {
            filteredLogs = currentLogs.filter(log => {
                const levelMatch = currentLevelFilter === 'all' || log.level === currentLevelFilter;
                const categoryMatch = currentCategoryFilter === 'all' || log.category === currentCategoryFilter;

                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const searchMatch = !searchTerm ||
                    log.message.toLowerCase().includes(searchTerm) ||
                    log.source.toLowerCase().includes(searchTerm);

                return levelMatch && categoryMatch && searchMatch;
            });
        }

        // 更新日志统计
        function updateLogStats() {
            // 优先使用从API返回的统计信息，否则从当前日志计算
            const stats = currentStats.total ? currentStats : {
                total: currentLogs.length,
                info: currentLogs.filter(log => log.level === 'info').length,
                warn: currentLogs.filter(log => log.level === 'warn').length,
                error: currentLogs.filter(log => log.level === 'error').length,
                debug: currentLogs.filter(log => log.level === 'debug').length
            };

            const container = document.getElementById('logStats');
            container.innerHTML = `
                <div class="glass-card text-center">
                    <div class="stat-icon mx-auto mb-2" style="width: 48px; height: 48px;">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="text-lg font-bold">${stats.total}</div>
                    <div class="text-sm text-muted">总日志</div>
                </div>
                <div class="glass-card text-center">
                    <div class="stat-icon mx-auto mb-2" style="width: 48px; height: 48px; background: rgba(59, 130, 246, 0.2);">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="text-lg font-bold">${stats.info}</div>
                    <div class="text-sm text-muted">信息</div>
                </div>
                <div class="glass-card text-center">
                    <div class="stat-icon mx-auto mb-2" style="width: 48px; height: 48px; background: rgba(245, 158, 11, 0.2);">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="text-lg font-bold">${stats.warn}</div>
                    <div class="text-sm text-muted">警告</div>
                </div>
                <div class="glass-card text-center">
                    <div class="stat-icon mx-auto mb-2" style="width: 48px; height: 48px; background: rgba(239, 68, 68, 0.2);">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="text-lg font-bold">${stats.error}</div>
                    <div class="text-sm text-muted">错误</div>
                </div>
                <div class="glass-card text-center">
                    <div class="stat-icon mx-auto mb-2" style="width: 48px; height: 48px; background: rgba(139, 92, 246, 0.2);">
                        <i class="fas fa-bug"></i>
                    </div>
                    <div class="text-lg font-bold">${stats.debug || 0}</div>
                    <div class="text-sm text-muted">调试</div>
                </div>
            `;
        }

        // 渲染日志列表
        function renderLogs() {
            const container = document.getElementById('logsContainer');
            const logCountEl = document.getElementById('logCount');

            if (filteredLogs.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-8">
                            <div class="text-muted">
                                <i class="fas fa-search text-2xl mb-3"></i>
                                <p>没有找到匹配的日志</p>
                                <button onclick="clearFilters()" class="btn btn-sm btn-primary mt-3">
                                    <i class="fas fa-times"></i>
                                    清除过滤器
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                logCountEl.textContent = '共 0 条';
                return;
            }

            const logsHTML = filteredLogs.map(log => {
                const timestamp = new Date(log.timestamp).toLocaleString('zh-CN', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                const levelClass = log.level === 'error' ? 'text-danger' :
                                 log.level === 'warn' ? 'text-warning' :
                                 log.level === 'info' ? 'text-success' : 'text-muted';

                return `
                    <tr class="log-level-${log.level}">
                        <td class="font-mono">${timestamp}</td>
                        <td>
                            <span class="badge badge-${log.level === 'error' ? 'danger' : log.level === 'warn' ? 'warning' : 'success'} ${levelClass}">
                                ${log.level.toUpperCase()}
                            </span>
                        </td>
                        <td class="text-muted">${log.category || '-'}</td>
                        <td class="text-muted">${log.action || '-'}</td>
                        <td class="break-words">${log.message}</td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = logsHTML;
            logCountEl.textContent = `共 ${filteredLogs.length} 条`;
        }

        // 级别过滤
        function filterByLevel(level) {
            currentLevelFilter = level;

            // 更新按钮状态
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('filter-active', btn.dataset.level === level);
            });

            applyFilters();
            renderLogs();
        }

        // 分类过滤
        function filterByCategory(category) {
            currentCategoryFilter = category;

            // 更新按钮状态
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('filter-active', btn.dataset.category === category);
            });

            applyFilters();
            renderLogs();
        }

        // 搜索日志
        function searchLogs() {
            applyFilters();
            renderLogs();
        }

        // 清除过滤器
        function clearFilters() {
            currentLevelFilter = 'all';
            currentCategoryFilter = 'all';
            document.getElementById('searchInput').value = '';

            // 重置按钮状态
            document.querySelectorAll('.filter-btn, .category-btn').forEach(btn => {
                btn.classList.remove('filter-active');
            });
            document.querySelector('[data-level="all"]').classList.add('filter-active');
            document.querySelector('[data-category="all"]').classList.add('filter-active');

            applyFilters();
            renderLogs();
        }

        // 刷新日志
        async function refreshLogs() {
            const icon = document.getElementById('refreshIcon');
            icon.classList.add('fa-spin');

            try {
                await loadLogs();
                components.showNotification('日志已刷新', 'success');
            } catch (error) {
                components.showNotification('刷新失败', 'error');
            } finally {
                icon.classList.remove('fa-spin');
            }
        }

        // 切换自动刷新
        function toggleAutoRefresh() {
            isAutoRefresh = !isAutoRefresh;
            const btn = document.getElementById('autoRefreshBtn');
            const text = document.getElementById('autoRefreshText');

            if (isAutoRefresh) {
                startAutoRefresh();
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-success');
                text.textContent = '自动刷新';
                components.showNotification('自动刷新已开启', 'success');
            } else {
                stopAutoRefresh();
                btn.classList.remove('btn-success');
                btn.classList.add('btn-secondary');
                text.textContent = '手动模式';
                components.showNotification('自动刷新已关闭', 'info');
            }
        }

        // 开始自动刷新
        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                if (isAutoRefresh) {
                    loadLogs();
                }
            }, 5000); // 每5秒刷新一次
        }

        // 停止自动刷新
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // 清空日志
        async function clearLogs() {
            if (!confirm('确定要清空所有日志吗？此操作不可恢复。')) {
                return;
            }

            try {
                const response = await fetch('/api/v1/logs', {
                    method: 'DELETE'
                });

                if (response.ok) {
                    currentLogs = [];
                    applyFilters();
                    updateLogStats();
                    renderLogs();
                    components.showNotification('日志已清空', 'success');
                } else {
                    components.showNotification('清空失败', 'error');
                }
            } catch (error) {
                console.error('清空日志失败:', error);
                components.showNotification('清空失败', 'error');
            }
        }

        // 下载日志
        function downloadLogs() {
            const logText = filteredLogs.map(log => {
                const timestamp = new Date(log.timestamp).toLocaleString('zh-CN');
                return `[${timestamp}] [${log.level.toUpperCase()}] [${log.category}] ${log.message}`;
            }).join('\n');

            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nsfw-go-logs-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            components.showNotification('日志已下载', 'success');
        }

        // 页面卸载时清理
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });
    </script>
    <script src="static/js/components.js"></script>
    <script src="static/js/modern-nav.js"></script>
</body>
</html>