<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统日志 - NSFW-GO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="static/css/design-system.css">
    <link rel="stylesheet" href="static/css/components.css">
    <style>
        .log-entry {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
        }

        .log-level-badge {
            min-width: 60px;
            text-align: center;
        }
    </style>
</head>

<body class="bg-dark text-main font-sans antialiased selection:bg-primary selection:text-white">
    <div class="flex h-screen overflow-hidden">
        <!-- 侧边栏容器 -->
        <div id="sidebar-container"></div>

        <!-- 主内容区 -->
        <div class="flex-1 flex flex-col h-screen overflow-hidden relative">
            <!-- 顶部装饰 -->
            <div
                class="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-primary/5 to-transparent pointer-events-none z-0">
            </div>

            <!-- 滚动内容区 -->
            <main class="flex-1 overflow-y-auto relative z-10 custom-scrollbar p-6 lg:p-10">
                <div class="max-w-7xl mx-auto">
                    <!-- 页面标题 -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                        <div>
                            <h1 class="text-3xl font-bold tracking-tight text-white mb-2">系统日志</h1>
                            <p class="text-muted">实时监控系统运行状态和错误信息</p>
                        </div>
                        <div class="flex gap-3">
                            <button id="autoRefreshBtn" onclick="toggleAutoRefresh()" class="btn btn-primary">
                                <i class="fas fa-sync-alt mr-2" id="refreshIcon"></i>
                                <span id="autoRefreshText">自动刷新</span>
                            </button>
                            <button onclick="downloadLogs()" class="btn btn-secondary">
                                <i class="fas fa-download mr-2"></i>下载
                            </button>
                            <button onclick="clearLogs()" class="btn btn-secondary text-red-400 hover:text-red-300">
                                <i class="fas fa-trash-alt mr-2"></i>清空
                            </button>
                        </div>
                    </div>

                    <!-- 过滤器 -->
                    <div class="glass-card p-4 mb-6 flex flex-wrap gap-4 items-center justify-between">
                        <div class="flex flex-wrap gap-4">
                            <!-- 级别过滤 -->
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-muted">级别:</span>
                                <div class="flex bg-white/5 rounded-lg p-1">
                                    <button onclick="filterByLevel('all')"
                                        class="filter-btn px-3 py-1 rounded-md text-xs font-medium transition-all bg-primary text-white"
                                        data-level="all">全部</button>
                                    <button onclick="filterByLevel('info')"
                                        class="filter-btn px-3 py-1 rounded-md text-xs font-medium transition-all text-muted hover:text-white"
                                        data-level="info">INFO</button>
                                    <button onclick="filterByLevel('warn')"
                                        class="filter-btn px-3 py-1 rounded-md text-xs font-medium transition-all text-muted hover:text-white"
                                        data-level="warn">WARN</button>
                                    <button onclick="filterByLevel('error')"
                                        class="filter-btn px-3 py-1 rounded-md text-xs font-medium transition-all text-muted hover:text-white"
                                        data-level="error">ERROR</button>
                                    <button onclick="filterByLevel('debug')"
                                        class="filter-btn px-3 py-1 rounded-md text-xs font-medium transition-all text-muted hover:text-white"
                                        data-level="debug">DEBUG</button>
                                </div>
                            </div>

                            <!-- 分类过滤 -->
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-muted">分类:</span>
                                <div class="flex bg-white/5 rounded-lg p-1">
                                    <button onclick="filterByCategory('all')"
                                        class="category-btn px-3 py-1 rounded-md text-xs font-medium transition-all bg-primary text-white"
                                        data-category="all">全部</button>
                                    <button onclick="filterByCategory('system')"
                                        class="category-btn px-3 py-1 rounded-md text-xs font-medium transition-all text-muted hover:text-white"
                                        data-category="system">系统</button>
                                    <button onclick="filterByCategory('crawler')"
                                        class="category-btn px-3 py-1 rounded-md text-xs font-medium transition-all text-muted hover:text-white"
                                        data-category="crawler">爬虫</button>
                                    <button onclick="filterByCategory('torrent')"
                                        class="category-btn px-3 py-1 rounded-md text-xs font-medium transition-all text-muted hover:text-white"
                                        data-category="torrent">下载</button>
                                </div>
                            </div>
                        </div>

                        <!-- 搜索 -->
                        <div class="relative w-full md:w-64">
                            <i
                                class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-muted text-xs"></i>
                            <input type="text" id="searchInput" oninput="searchLogs()"
                                class="w-full bg-input border-transparent focus:border-primary rounded-lg py-2 pl-8 pr-4 text-sm text-white placeholder-muted"
                                placeholder="搜索日志内容...">
                        </div>
                    </div>

                    <!-- 统计卡片 -->
                    <div id="logStats" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                        <!-- JS 注入 -->
                    </div>

                    <!-- 日志列表 -->
                    <div class="glass-card overflow-hidden">
                        <div class="px-6 py-4 border-b border-white/5 flex justify-between items-center">
                            <h3 class="text-lg font-bold text-white">实时日志</h3>
                            <span id="logCount" class="text-sm text-muted">共 0 条</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="text-xs text-muted border-b border-white/5 bg-white/5">
                                        <th class="px-6 py-3 font-medium">时间</th>
                                        <th class="px-6 py-3 font-medium">级别</th>
                                        <th class="px-6 py-3 font-medium">分类</th>
                                        <th class="px-6 py-3 font-medium">消息</th>
                                    </tr>
                                </thead>
                                <tbody id="logsContainer" class="text-sm divide-y divide-white/5">
                                    <!-- JS 注入 -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </main>
        </div>
    </div>

    <script src="static/js/components.js"></script>
    <script src="static/js/sidebar.js"></script>
    <script>
        // 全局变量
        let currentLogs = [];
        let filteredLogs = [];
        let currentStats = {};
        let currentLevelFilter = 'all';
        let currentCategoryFilter = 'all';
        let autoRefreshInterval = null;
        let isAutoRefresh = true;
        let isFirstLoad = true;

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function () {
            loadLogs();
            startAutoRefresh();
        });

        // 加载日志数据
        async function loadLogs() {
            const container = document.getElementById('logsContainer');

            // 显示加载状态 (仅首次)
            if (isFirstLoad && !currentLogs.length) {
                container.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center text-muted">
                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>加载日志数据...</p>
                        </td>
                    </tr>
                `;
            }

            try {
                const response = await fetch('/api/v1/logs');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.success && data.data) {
                    currentLogs = data.data;
                    if (data.meta && data.meta.stats) {
                        currentStats = data.meta.stats;
                    }
                    applyFilters();
                    updateLogStats();
                    renderLogs();

                    if (!isFirstLoad && !isAutoRefresh) {
                        components.showNotification('日志已刷新', 'success');
                    }
                    isFirstLoad = false;
                } else {
                    throw new Error(data.message || '返回数据格式错误');
                }
            } catch (error) {
                console.error('获取日志失败:', error);

                // 仅在首次加载失败时使用模拟数据
                if (isFirstLoad) {
                    currentLogs = generateMockLogs();
                    applyFilters();
                    updateLogStats();
                    renderLogs();
                    components.showNotification('无法连接到日志服务，正在使用模拟数据', 'warning');
                    isFirstLoad = false;
                }
            }
        }

        // 生成模拟日志数据
        function generateMockLogs() {
            const levels = ['info', 'warn', 'error', 'debug'];
            const categories = ['system', 'crawler', 'scanner', 'torrent', 'config'];
            const mockLogs = [];

            const messages = {
                system: ['服务器启动完成', '数据库连接成功', 'API服务已就绪', '健康检查通过'],
                crawler: ['开始爬取JAVDb排行榜', '爬取完成，共获取123条数据', '遇到反爬虫限制，等待重试', '排行榜数据已更新'],
                scanner: ['开始扫描本地媒体库', '发现新文件：SONE-123.mp4', '扫描完成，共处理456个文件', '跳过重复文件'],
                torrent: ['添加下载任务成功', '种子搜索完成', '下载进度：45%', 'qBittorrent连接测试成功'],
                config: ['配置已更新', '数据库配置备份完成', '连接测试成功', '工作模式已切换']
            };

            for (let i = 0; i < 50; i++) {
                const category = categories[Math.floor(Math.random() * categories.length)];
                const level = levels[Math.floor(Math.random() * levels.length)];
                const timestamp = new Date(Date.now() - Math.random() * 24 * 60 * 60 * 1000);
                const message = messages[category][Math.floor(Math.random() * messages[category].length)];

                mockLogs.push({
                    id: i + 1,
                    timestamp: timestamp.toISOString(),
                    level: level,
                    category: category,
                    message: message,
                    source: `${category}-service`
                });
            }

            return mockLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        // 应用过滤器
        function applyFilters() {
            filteredLogs = currentLogs.filter(log => {
                const levelMatch = currentLevelFilter === 'all' || log.level === currentLevelFilter;
                const categoryMatch = currentCategoryFilter === 'all' || log.category === currentCategoryFilter;

                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const searchMatch = !searchTerm ||
                    log.message.toLowerCase().includes(searchTerm) ||
                    (log.source && log.source.toLowerCase().includes(searchTerm));

                return levelMatch && categoryMatch && searchMatch;
            });
        }

        // 更新日志统计
        function updateLogStats() {
            const stats = currentStats.total ? currentStats : {
                total: currentLogs.length,
                info: currentLogs.filter(log => log.level === 'info').length,
                warn: currentLogs.filter(log => log.level === 'warn').length,
                error: currentLogs.filter(log => log.level === 'error').length,
                debug: currentLogs.filter(log => log.level === 'debug').length
            };

            const container = document.getElementById('logStats');
            container.innerHTML = `
                <div class="glass-card p-4 text-center">
                    <div class="text-2xl font-bold text-white mb-1">${stats.total}</div>
                    <div class="text-xs text-muted uppercase">总日志</div>
                </div>
                <div class="glass-card p-4 text-center border-b-2 border-blue-500">
                    <div class="text-2xl font-bold text-blue-400 mb-1">${stats.info}</div>
                    <div class="text-xs text-muted uppercase">Info</div>
                </div>
                <div class="glass-card p-4 text-center border-b-2 border-yellow-500">
                    <div class="text-2xl font-bold text-yellow-400 mb-1">${stats.warn}</div>
                    <div class="text-xs text-muted uppercase">Warn</div>
                </div>
                <div class="glass-card p-4 text-center border-b-2 border-red-500">
                    <div class="text-2xl font-bold text-red-400 mb-1">${stats.error}</div>
                    <div class="text-xs text-muted uppercase">Error</div>
                </div>
                <div class="glass-card p-4 text-center border-b-2 border-purple-500">
                    <div class="text-2xl font-bold text-purple-400 mb-1">${stats.debug || 0}</div>
                    <div class="text-xs text-muted uppercase">Debug</div>
                </div>
            `;
        }

        // 渲染日志列表
        function renderLogs() {
            const container = document.getElementById('logsContainer');
            const logCountEl = document.getElementById('logCount');

            if (filteredLogs.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center text-muted">
                            <i class="fas fa-search text-2xl mb-2"></i>
                            <p>没有找到匹配的日志</p>
                        </td>
                    </tr>
                `;
                logCountEl.textContent = '共 0 条';
                return;
            }

            const logsHTML = filteredLogs.map(log => {
                const timestamp = new Date(log.timestamp).toLocaleString('zh-CN', {
                    month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit'
                });

                let levelBadgeClass = 'bg-gray-700 text-gray-300';
                if (log.level === 'info') levelBadgeClass = 'bg-blue-500/20 text-blue-400';
                if (log.level === 'warn') levelBadgeClass = 'bg-yellow-500/20 text-yellow-400';
                if (log.level === 'error') levelBadgeClass = 'bg-red-500/20 text-red-400';
                if (log.level === 'debug') levelBadgeClass = 'bg-purple-500/20 text-purple-400';

                return `
                    <tr class="hover:bg-white/5 transition-colors log-entry">
                        <td class="px-6 py-3 whitespace-nowrap text-muted font-mono text-xs">${timestamp}</td>
                        <td class="px-6 py-3 whitespace-nowrap">
                            <span class="px-2 py-1 rounded text-xs font-bold uppercase ${levelBadgeClass} log-level-badge inline-block">
                                ${log.level}
                            </span>
                        </td>
                        <td class="px-6 py-3 whitespace-nowrap text-muted text-xs">${log.category || '-'}</td>
                        <td class="px-6 py-3 text-gray-300 break-all">${log.message}</td>
                    </tr>
                `;
            }).join('');

            container.innerHTML = logsHTML;
            logCountEl.textContent = `共 ${filteredLogs.length} 条`;
        }

        // 级别过滤
        function filterByLevel(level) {
            currentLevelFilter = level;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.level === level) {
                    btn.classList.remove('text-muted', 'hover:text-white');
                    btn.classList.add('bg-primary', 'text-white');
                } else {
                    btn.classList.add('text-muted', 'hover:text-white');
                    btn.classList.remove('bg-primary', 'text-white');
                }
            });
            applyFilters();
            renderLogs();
        }

        // 分类过滤
        function filterByCategory(category) {
            currentCategoryFilter = category;
            document.querySelectorAll('.category-btn').forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.remove('text-muted', 'hover:text-white');
                    btn.classList.add('bg-primary', 'text-white');
                } else {
                    btn.classList.add('text-muted', 'hover:text-white');
                    btn.classList.remove('bg-primary', 'text-white');
                }
            });
            applyFilters();
            renderLogs();
        }

        // 搜索日志
        function searchLogs() {
            applyFilters();
            renderLogs();
        }

        // 切换自动刷新
        function toggleAutoRefresh() {
            isAutoRefresh = !isAutoRefresh;
            const btn = document.getElementById('autoRefreshBtn');
            const text = document.getElementById('autoRefreshText');
            const icon = document.getElementById('refreshIcon');

            if (isAutoRefresh) {
                startAutoRefresh();
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
                text.textContent = '自动刷新';
                icon.classList.add('fa-spin'); // 可选：让图标旋转表示正在自动刷新
                components.showNotification('自动刷新已开启', 'success');
            } else {
                stopAutoRefresh();
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
                text.textContent = '手动模式';
                icon.classList.remove('fa-spin');
                components.showNotification('自动刷新已关闭', 'info');
            }
        }

        // 开始自动刷新
        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                if (isAutoRefresh) {
                    loadLogs();
                }
            }, 5000);
        }

        // 停止自动刷新
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // 清空日志
        async function clearLogs() {
            if (!confirm('确定要清空所有日志吗？此操作不可恢复。')) {
                return;
            }
            try {
                const response = await fetch('/api/v1/logs', { method: 'DELETE' });
                if (response.ok) {
                    currentLogs = [];
                    applyFilters();
                    updateLogStats();
                    renderLogs();
                    components.showNotification('日志已清空', 'success');
                } else {
                    components.showNotification('清空失败', 'error');
                }
            } catch (error) {
                console.error('清空日志失败:', error);
                components.showNotification('清空失败', 'error');
            }
        }

        // 下载日志
        function downloadLogs() {
            const logText = filteredLogs.map(log => {
                const timestamp = new Date(log.timestamp).toLocaleString('zh-CN');
                return `[${timestamp}] [${log.level.toUpperCase()}] [${log.category}] ${log.message}`;
            }).join('\n');

            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nsfw-go-logs-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            components.showNotification('日志已下载', 'success');
        }

        // 页面卸载时清理
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });
    </script>
</body>

</html>