<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” å½±ç‰‡æœç´¢ - NSFW-Go</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="static/css/design-system.css">
    <link rel="stylesheet" href="static/css/components.css">
    <link rel="stylesheet" href="static/css/tailwind-fixes.css">
    <style>
        /* é¡µé¢ç‰¹å®šæ ·å¼ */
        .search-container {
            min-height: calc(100vh - 64px);
            padding: 2rem 1rem;
        }
        
        .movie-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        @media (max-width: 640px) {
            .movie-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 1rem;
            }
        }
        
        .movie-image {
            aspect-ratio: 3/4;
            object-fit: cover;
            width: 100%;
            height: 100%;
        }
        
        .skeleton-image {
            aspect-ratio: 3/4;
            background: linear-gradient(90deg, var(--bg-dark-secondary) 25%, var(--bg-dark-tertiary) 50%, var(--bg-dark-secondary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ å°†ç”±modern-nav.jsè‡ªåŠ¨æ’å…¥ -->
    
    <!-- ä¸»å†…å®¹åŒº -->
    <main class="search-container max-w-7xl mx-auto">
        <!-- æœç´¢å¤´éƒ¨ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4">
                <span class="glow-text">ğŸ” å½±ç‰‡æœç´¢</span>
            </h1>
            <p class="text-lg text-muted">æœç´¢æœ¬åœ°åº“å’Œåœ¨çº¿èµ„æºï¼Œå¿«é€Ÿæ‰¾åˆ°æ‚¨æƒ³è¦çš„å½±ç‰‡ ğŸ¬</p>
        </div>
        
        <!-- æœç´¢æ¡† -->
        <div class="glass-card p-6 mb-8">
            <div class="max-w-3xl mx-auto">
                <div class="input-group">
                    <label class="flex items-center gap-2">
                        <i class="fas fa-search text-primary-light"></i>
                        <span>æœç´¢å…³é”®è¯</span>
                    </label>
                    <div class="flex gap-3">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="ğŸ¯ è¾“å…¥ç•ªå·ã€å¥³ä¼˜åæˆ–å…³é”®è¯..." 
                            class="input-field flex-1"
                            onkeypress="if(event.key === 'Enter') performSearch()"
                        >
                        <button onclick="performSearch()" class="btn btn-primary">
                            <i class="fas fa-search"></i>
                            <span>æœç´¢</span>
                        </button>
                    </div>
                </div>
                
                <!-- æœç´¢é€‰é¡¹ -->
                <div class="mt-4 flex flex-wrap gap-3">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="searchLocal" checked class="rounded">
                        <span class="text-sm">ğŸ“ æœç´¢æœ¬åœ°åº“</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="searchOnline" checked class="rounded">
                        <span class="text-sm">ğŸŒ æœç´¢åœ¨çº¿èµ„æº</span>
                    </label>
                </div>
                
                <!-- çƒ­é—¨æ ‡ç­¾ -->
                <div class="mt-4">
                    <p class="text-sm text-muted mb-2">ğŸ”¥ çƒ­é—¨æœç´¢</p>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="quickSearch('SONE')" class="badge badge-primary cursor-pointer hover:scale-105 transition">SONE</button>
                        <button onclick="quickSearch('SSIS')" class="badge badge-primary cursor-pointer hover:scale-105 transition">SSIS</button>
                        <button onclick="quickSearch('IPX')" class="badge badge-primary cursor-pointer hover:scale-105 transition">IPX</button>
                        <button onclick="quickSearch('STARS')" class="badge badge-primary cursor-pointer hover:scale-105 transition">STARS</button>
                        <button onclick="quickSearch('MIDV')" class="badge badge-primary cursor-pointer hover:scale-105 transition">MIDV</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æœç´¢ç±»å‹åˆ‡æ¢ -->
        <div class="flex gap-3 mb-6">
            <button id="localTab" onclick="switchTab('local')" class="btn btn-primary">
                <i class="fas fa-folder"></i>
                <span>æœ¬åœ°å½±ç‰‡</span>
                <span id="localCount" class="badge badge-success hidden">0</span>
            </button>
            <button id="onlineTab" onclick="switchTab('online')" class="btn btn-secondary">
                <i class="fas fa-globe"></i>
                <span>åœ¨çº¿èµ„æº</span>
                <span id="onlineCount" class="badge badge-warning hidden">0</span>
            </button>
        </div>
        
        <!-- æœç´¢ç»“æœå®¹å™¨ -->
        <div id="searchResults">
            <!-- åˆå§‹çŠ¶æ€ -->
            <div class="empty-state flex-center" style="min-height: 400px;">
                <div class="text-center">
                    <i class="fas fa-search empty-icon text-6xl mb-4"></i>
                    <p class="text-xl text-muted">ğŸ‘† è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</p>
                    <p class="text-sm text-muted mt-2">æ”¯æŒç•ªå·ã€å¥³ä¼˜åã€ç³»åˆ—åç­‰å¤šç§æœç´¢æ–¹å¼</p>
                </div>
            </div>
        </div>
        
        <!-- åŠ è½½æ›´å¤š -->
        <div id="loadMoreContainer" class="hidden text-center mt-8">
            <button onclick="loadMore()" class="btn btn-secondary">
                <i class="fas fa-plus"></i>
                åŠ è½½æ›´å¤š
            </button>
        </div>
    </main>
    
    <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
    <button id="backToTop" onclick="scrollToTop()" class="fixed bottom-8 right-8 btn btn-primary rounded-full w-12 h-12 hidden">
        <i class="fas fa-arrow-up"></i>
    </button>
    
    <script src="static/js/components.js"></script>
    <script src="static/js/modern-nav.js"></script>
    <script>
        // åˆå§‹åŒ–ç»„ä»¶ï¼ˆcomponents å·²åœ¨ components.js ä¸­å®šä¹‰ï¼‰

        let currentTab = 'local';
        let localResults = [];
        let onlineResults = [];
        let currentPage = 1;
        let isLoading = false;

        // å…¨å±€å‡½æ•°å®šä¹‰ï¼ˆå¿…é¡»åœ¨é¡µé¢åŠ è½½å‰å®šä¹‰ï¼Œä¾›onclickä½¿ç”¨ï¼‰

        // å¿«é€Ÿæœç´¢
        function quickSearch(keyword) {
            document.getElementById('searchInput').value = keyword;
            performSearch();
        }

        // æ‰§è¡Œæœç´¢
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                components.showNotification('ğŸ˜… è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'warning');
                return;
            }

            const searchLocal = document.getElementById('searchLocal').checked;
            const searchOnline = document.getElementById('searchOnline').checked;

            if (!searchLocal && !searchOnline) {
                components.showNotification('ğŸ˜… è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæœç´¢èŒƒå›´', 'warning');
                return;
            }

            try {
                // é‡ç½®ç»“æœ
                localResults = [];
                onlineResults = [];
                currentPage = 1;

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const resultsContainer = document.getElementById('searchResults');
                resultsContainer.innerHTML = components.createLoadingState('ğŸ” æ­£åœ¨æœç´¢...');

                // æ‰§è¡Œæœç´¢
                const promises = [];
                if (searchLocal) {
                    promises.push(searchLocalMovies(query));
                }
                if (searchOnline) {
                    promises.push(searchOnlineMovies(query));
                }

                await Promise.all(promises);

                // æ˜¾ç¤ºç¬¬ä¸€ä¸ªæœ‰ç»“æœçš„æ ‡ç­¾
                if (localResults.length > 0) {
                    switchTab('local');
                } else if (onlineResults.length > 0) {
                    switchTab('online');
                } else {
                    resultsContainer.innerHTML = components.createEmptyState(
                        'ğŸ˜” æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å½±ç‰‡',
                        'fa-film',
                        {
                            label: 'é‡æ–°æœç´¢',
                            icon: 'fas fa-search',
                            onClick: 'document.getElementById("searchInput").focus()'
                        }
                    );
                }

                // æ›´æ–°è®¡æ•°
                updateCounts();
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                components.showNotification('ğŸ˜… æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                const resultsContainer = document.getElementById('searchResults');
                resultsContainer.innerHTML = components.createEmptyState(
                    'ğŸ˜” æœç´¢å¤±è´¥',
                    'fa-exclamation-triangle',
                    {
                        label: 'é‡æ–°æœç´¢',
                        icon: 'fas fa-search',
                        onClick: 'performSearch()'
                    }
                );
            }
        }

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tab) {
            currentTab = tab;
            currentPage = 1;

            // æ›´æ–°æ ‡ç­¾æ ·å¼
            const localTab = document.getElementById('localTab');
            const onlineTab = document.getElementById('onlineTab');

            if (tab === 'local') {
                localTab.className = 'btn btn-primary';
                onlineTab.className = 'btn btn-secondary';
                displayResults(localResults);
            } else {
                localTab.className = 'btn btn-secondary';
                onlineTab.className = 'btn btn-primary';
                displayResults(onlineResults);
            }
        }

        // æŸ¥çœ‹å½±ç‰‡è¯¦æƒ…
        function viewMovieDetail(code) {
            if (currentTab === 'local') {
                window.location.href = `/local-movies.html?code=${code}`;
            } else {
                window.open(`https://javdb.com/search?q=${code}`, '_blank');
            }
        }

        // æœç´¢ç§å­
        async function searchTorrent(code) {
            try {
                // æ˜¾ç¤ºä¸‹è½½æç¤º
                components.showNotification('ğŸ¬ æ­£åœ¨å¯åŠ¨æ™ºèƒ½ä¸‹è½½...', 'info');

                // è·å–å½±ç‰‡ä¿¡æ¯ï¼ˆä»å½“å‰æœç´¢ç»“æœä¸­ï¼‰
                let title = code; // é»˜è®¤ä½¿ç”¨ç•ªå·ä½œä¸ºæ ‡é¢˜
                let coverUrl = ''; // è·å–å°é¢å›¾ç‰‡URL
                const onlineResult = onlineResults.find(movie => movie.code === code);
                if (onlineResult) {
                    title = onlineResult.title || code;
                    coverUrl = onlineResult.cover_url || '';
                }

                // è°ƒç”¨æ’è¡Œæ¦œä¸‹è½½æœåŠ¡ APIï¼ˆä½¿ç”¨ä¸æ’è¡Œæ¦œä¸‹è½½ç›¸åŒçš„é€»è¾‘ï¼‰
                const downloadResponse = await fetch('/api/v1/rankings/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: code,
                        title: title,
                        cover_url: coverUrl,  // ä¼ é€’å°é¢å›¾ç‰‡URL
                        source: 'manual',    // æ‰‹åŠ¨ä¸‹è½½æº
                        rank_type: 'daily'   // é»˜è®¤ä½¿ç”¨æ—¥æ¦œç±»å‹
                    })
                });

                if (!downloadResponse.ok) {
                    throw new Error('å¯åŠ¨ä¸‹è½½ä»»åŠ¡å¤±è´¥');
                }

                const downloadResult = await downloadResponse.json();
                if (downloadResult.success) {
                    components.showNotification('âœ… ä¸‹è½½ä»»åŠ¡å·²å¯åŠ¨ï¼Œæ­£åœ¨åå°å¤„ç†...', 'success');
                } else {
                    components.showNotification(`âŒ ${downloadResult.error || 'å¯åŠ¨ä¸‹è½½ä»»åŠ¡å¤±è´¥'}`, 'error');
                }

            } catch (error) {
                console.error('å¯åŠ¨ä¸‹è½½ä»»åŠ¡å¤±è´¥:', error);
                components.showNotification(`âŒ ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½æ›´å¤š
        function loadMore() {
            currentPage++;
            const results = currentTab === 'local' ? localResults : onlineResults;
            displayResults(results);
        }

        // è¿”å›é¡¶éƒ¨
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('q');
            if (query) {
                document.getElementById('searchInput').value = query;
                performSearch();
            }
            
            // ç›‘å¬æ»šåŠ¨äº‹ä»¶
            window.addEventListener('scroll', () => {
                const backToTop = document.getElementById('backToTop');
                if (window.scrollY > 300) {
                    backToTop.classList.remove('hidden');
                } else {
                    backToTop.classList.add('hidden');
                }
            });
        });
        
        
        // æœç´¢æœ¬åœ°å½±ç‰‡
        async function searchLocalMovies(query) {
            try {
                const response = await fetch(`/api/v1/local/search?keyword=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.code === 'SUCCESS' && data.data) {
                    localResults = data.data;
                    components.showNotification(`ğŸ“ æ‰¾åˆ° ${localResults.length} éƒ¨æœ¬åœ°å½±ç‰‡`, 'success');
                }
            } catch (error) {
                console.error('æœç´¢æœ¬åœ°å½±ç‰‡å¤±è´¥:', error);
                components.showNotification('ğŸ˜… æœç´¢æœ¬åœ°å½±ç‰‡å¤±è´¥', 'error');
            }
        }
        
        // æœç´¢åœ¨çº¿å½±ç‰‡
        async function searchOnlineMovies(query) {
            try {
                const response = await fetch(`/api/v1/search/javdb?keyword=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.code === 'SUCCESS' && data.data) {
                    onlineResults = data.data;
                    components.showNotification(`ğŸŒ æ‰¾åˆ° ${onlineResults.length} ä¸ªåœ¨çº¿èµ„æº`, 'success');
                }
            } catch (error) {
                console.error('æœç´¢åœ¨çº¿å½±ç‰‡å¤±è´¥:', error);
                components.showNotification('ğŸ˜… æœç´¢åœ¨çº¿èµ„æºå¤±è´¥', 'error');
            }
        }
        
        // æ˜¾ç¤ºç»“æœ
        function displayResults(results) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = components.createEmptyState(
                    currentTab === 'local' ? 'ğŸ˜” æœ¬åœ°åº“ä¸­æ²¡æœ‰æ‰¾åˆ°' : 'ğŸ˜” åœ¨çº¿èµ„æºä¸­æ²¡æœ‰æ‰¾åˆ°',
                    'fa-film'
                );
                return;
            }
            
            // åˆ†é¡µæ˜¾ç¤º
            const pageSize = 12;
            const start = 0;
            const end = Math.min(currentPage * pageSize, results.length);
            const displayResults = results.slice(start, end);
            
            // æ¸²æŸ“å½±ç‰‡å¡ç‰‡
            container.innerHTML = `
                <div class="movie-grid">
                    ${displayResults.map(movie => createMovieCard(movie)).join('')}
                </div>
            `;
            
            // æ˜¾ç¤º/éšè—åŠ è½½æ›´å¤šæŒ‰é’®
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            if (end < results.length) {
                loadMoreContainer.classList.remove('hidden');
            } else {
                loadMoreContainer.classList.add('hidden');
            }
        }
        
        // åˆ›å»ºå½±ç‰‡å¡ç‰‡
        function createMovieCard(movie) {
            const isLocal = currentTab === 'local';
            const title = movie.title || movie.code || 'æœªçŸ¥å½±ç‰‡';
            const code = movie.code || '';
            const actresses = movie.actresses || movie.actors || [];
            const releaseDate = movie.release_date || movie.date || '';
            const hasLocal = movie.has_local || false;
            
            return `
                <div class="glass-card hover-scale cursor-pointer" onclick="viewMovieDetail('${code}')">
                    <div class="relative overflow-hidden" style="aspect-ratio: 3/4;">
                        ${movie.cover_url ? `
                            <img src="${movie.cover_url}" alt="${title}" class="movie-image" loading="lazy" onerror="this.src='https://via.placeholder.com/300x400?text=No+Image'">
                        ` : `
                            <div class="skeleton-image"></div>
                        `}
                        ${isLocal ? `
                            <div class="absolute top-2 right-2">
                                <span class="badge badge-success">ğŸ“ æœ¬åœ°</span>
                            </div>
                        ` : hasLocal ? `
                            <div class="absolute top-2 right-2">
                                <span class="badge badge-warning">âœ… å·²æœ‰</span>
                            </div>
                        ` : ''}
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-sm mb-2 line-clamp-2">${title}</h3>
                        <div class="space-y-1 text-xs text-muted">
                            ${code ? `<p>ğŸ¬ ${code}</p>` : ''}
                            ${actresses.length > 0 ? `<p>ğŸ‘¤ ${actresses.join(', ')}</p>` : ''}
                            ${releaseDate ? `<p>ğŸ“… ${releaseDate}</p>` : ''}
                        </div>
                        ${!isLocal ? `
                            <div class="mt-3 flex gap-2">
                                <button onclick="event.stopPropagation(); searchTorrent('${code}')" class="btn btn-sm btn-primary flex-1">
                                    <i class="fas fa-download"></i>
                                    ä¸‹è½½
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // æ›´æ–°è®¡æ•°
        function updateCounts() {
            const localCount = document.getElementById('localCount');
            const onlineCount = document.getElementById('onlineCount');

            if (localResults.length > 0) {
                localCount.textContent = localResults.length;
                localCount.classList.remove('hidden');
            } else {
                localCount.classList.add('hidden');
            }

            if (onlineResults.length > 0) {
                onlineCount.textContent = onlineResults.length;
                onlineCount.classList.remove('hidden');
            } else {
                onlineCount.classList.add('hidden');
            }
        }
    </script>
</body>
</html>